# Phase 2: ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é«˜åº¦åŒ– å®Ÿè£…è¨ˆç”»æ›¸

**ãƒ•ã‚§ãƒ¼ã‚ºæœŸé–“**: 4æ—¥é–“  
**å®Ÿè£…æ—¥**: 2025å¹´7æœˆ1æ—¥ ã€œ 2025å¹´7æœˆ4æ—¥  
**æ‹…å½“ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢**: ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ æ‹…å½“  
**å‰ææ¡ä»¶**: Phase 1å®Œäº†ã€æ—¢å­˜ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®ç†è§£

---

## ğŸ¯ **Phase 2 å®Ÿè£…ç›®æ¨™**

### **2.1 ä¸»è¦æ©Ÿèƒ½å®Ÿè£…**
- **é«˜åº¦è²¡å‹™ç®¡ç†ãƒ»LTVåˆ†æã‚·ã‚¹ãƒ†ãƒ **: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåç›Šäºˆæ¸¬ãƒ»é¡§å®¢LTVç®—å‡º
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ**: ã‚¤ãƒ™ãƒ³ãƒˆãƒ»é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è‡ªå‹•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- **ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ãƒŠãƒ¬ãƒƒã‚¸è‡ªå‹•åŒ–**: å®Œäº†ã‚¿ã‚¹ã‚¯ã‹ã‚‰è‡ªå‹•ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆ
- **AIæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†æ**: æˆåŠŸç¢ºç‡ãƒ»ãƒªã‚¹ã‚¯è©•ä¾¡ã®è‡ªå‹•åŒ–

### **2.2 æŠ€è¡“è¦ä»¶**
- æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨æ´»ç”¨
- AIè©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³ã®æ‹¡å¼µãƒ»å¼·åŒ–
- è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªç®¡ç†ãƒ»æš—å·åŒ–

---

## ğŸ“‹ **Phase 2 å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

### **2.1 é«˜åº¦è²¡å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (1.5æ—¥)**
- [ ] è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ‹¡å¼µ
- [ ] LTVè¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…
- [ ] åç›Šäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
- [ ] è²¡å‹™ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½

### **2.2 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ (1æ—¥)**
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
- [ ] é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- [ ] AIãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæœ€é©åŒ–

### **2.3 ãƒŠãƒ¬ãƒƒã‚¸è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ  (1æ—¥)**
- [ ] ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ãƒ•ãƒƒã‚¯å®Ÿè£…
- [ ] ãƒŠãƒ¬ãƒƒã‚¸åˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³
- [ ] è‡ªå‹•ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆæ©Ÿèƒ½
- [ ] ãƒŠãƒ¬ãƒƒã‚¸å“è³ªè©•ä¾¡

### **2.4 AIæ”¯æ´ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ†æ (0.5æ—¥)**
- [ ] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæˆåŠŸç‡äºˆæ¸¬
- [ ] ãƒªã‚¹ã‚¯è©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
- [ ] æ”¹å–„ææ¡ˆã‚·ã‚¹ãƒ†ãƒ 

---

## ğŸ”§ **è©³ç´°å®Ÿè£…ã‚¬ã‚¤ãƒ‰**

### **2.1 é«˜åº¦è²¡å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…**

#### **2.1.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ‹¡å¼µ**
```sql
-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè²¡å‹™è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE project_financial_details (
  id VARCHAR(255) PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id VARCHAR(255) NOT NULL,
  
  -- åŸºæœ¬å¥‘ç´„æƒ…å ±
  base_contract_value DECIMAL(12,2) DEFAULT 0,
  contract_type VARCHAR(50) DEFAULT 'FIXED',
  payment_schedule JSONB DEFAULT '{}',
  
  -- å£²ä¸Šäºˆæ¸¬
  additional_work_probability FLOAT DEFAULT 0.3,
  additional_work_expected_value DECIMAL(12,2) DEFAULT 0,
  maintenance_contract_probability FLOAT DEFAULT 0.5,
  maintenance_annual_value DECIMAL(12,2) DEFAULT 0,
  referral_probability FLOAT DEFAULT 0.2,
  referral_expected_value DECIMAL(12,2) DEFAULT 0,
  
  -- ã‚³ã‚¹ãƒˆè©³ç´°
  direct_labor_cost DECIMAL(12,2) DEFAULT 0,
  indirect_labor_cost DECIMAL(12,2) DEFAULT 0,
  external_contractor_cost DECIMAL(12,2) DEFAULT 0,
  tool_license_cost DECIMAL(12,2) DEFAULT 0,
  infrastructure_cost DECIMAL(12,2) DEFAULT 0,
  
  -- ãƒªã‚¹ã‚¯ãƒ»å“è³ªç®¡ç†
  risk_buffer_percentage FLOAT DEFAULT 0.15,
  quality_assurance_cost DECIMAL(12,2) DEFAULT 0,
  contingency_reserve DECIMAL(12,2) DEFAULT 0,
  
  -- äºˆæ¸¬ç²¾åº¦ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  confidence_level FLOAT DEFAULT 0.8,
  prediction_model_version VARCHAR(20) DEFAULT 'v1.0',
  last_updated_at TIMESTAMP DEFAULT NOW(),
  created_by VARCHAR(255),
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

-- é¡§å®¢LTVåˆ†æãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE customer_ltv_analysis (
  id VARCHAR(255) PRIMARY KEY DEFAULT gen_random_uuid(),
  connection_id VARCHAR(255) NOT NULL,
  
  -- LTVæ§‹æˆè¦ç´ 
  initial_project_value DECIMAL(12,2) DEFAULT 0,
  continuation_probability FLOAT DEFAULT 0.7,
  average_projects_per_year FLOAT DEFAULT 1.5,
  price_growth_rate FLOAT DEFAULT 0.1,
  relationship_duration_years INTEGER DEFAULT 5,
  
  -- ç´¹ä»‹ä¾¡å€¤
  referral_probability FLOAT DEFAULT 0.3,
  referral_average_value DECIMAL(12,2) DEFAULT 0,
  referral_multiplier FLOAT DEFAULT 1.0,
  
  -- è¨ˆç®—çµæœ
  total_ltv DECIMAL(12,2) DEFAULT 0,
  discounted_ltv DECIMAL(12,2) DEFAULT 0,
  discount_rate FLOAT DEFAULT 0.1,
  
  -- åˆ†æçµæœ
  risk_factors JSONB DEFAULT '[]',
  opportunities JSONB DEFAULT '[]',
  recommended_actions JSONB DEFAULT '[]',
  confidence_score FLOAT DEFAULT 0.8,
  
  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  analysis_date TIMESTAMP DEFAULT NOW(),
  prediction_model_version VARCHAR(20) DEFAULT 'v1.0',
  created_by VARCHAR(255),
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  FOREIGN KEY (connection_id) REFERENCES connections(id) ON DELETE CASCADE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_project_financial_project_id ON project_financial_details(project_id);
CREATE INDEX idx_project_financial_contract_value ON project_financial_details(base_contract_value);
CREATE INDEX idx_customer_ltv_connection_id ON customer_ltv_analysis(connection_id);
CREATE INDEX idx_customer_ltv_total ON customer_ltv_analysis(total_ltv);
```

#### **2.1.2 LTVåˆ†æã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…**
```typescript
// src/services/CustomerLTVAnalyzer.ts
import { AI_SERVICE } from './ai-service';

export interface CustomerLTVData {
  connectionId: string;
  customrName: string;
  firstProjectDate: Date;
  projectHistory: ProjectHistoryItem[];
  satisfactionMetrics: SatisfactionMetrics;
  industryProfile: IndustryProfile;
  companyProfile: CompanyProfile;
}

export interface LTVAnalysisResult {
  ltvCalculation: {
    initialProjectValue: number;
    continuationProbability: number;
    averageProjectsPerYear: number;
    priceGrowthRate: number;
    relationshipDuration: number;
    referralProbability: number;
    referralAverageValue: number;
    totalLTV: number;
    discountedLTV: number;
    discountRate: number;
  };
  riskFactors: string[];
  opportunities: string[];
  recommendedActions: string[];
  confidenceLevel: number;
  comparisons: {
    industryAverage: number;
    companyPerformance: 'ABOVE' | 'AVERAGE' | 'BELOW';
  };
}

export class CustomerLTVAnalyzer {
  constructor(
    private aiService: typeof AI_SERVICE,
    private connectionService: any,
    private projectService: any
  ) {}

  /**
   * åŒ…æ‹¬çš„LTVåˆ†æå®Ÿè¡Œ
   */
  async calculateComprehensiveLTV(
    connectionId: string
  ): Promise<LTVAnalysisResult> {
    
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿åé›†
    const customerData = await this.gatherCustomerData(connectionId);
    const industryBenchmarks = await this.getIndustryBenchmarks(customerData.industryProfile);
    const historicalPerformance = await this.analyzeHistoricalPerformance(customerData);
    
    // AI ã«ã‚ˆã‚‹ç·åˆLTVåˆ†æ
    const ltvAnalysis = await this.aiService.evaluateWithGemini(`
    é¡§å®¢LTVåŒ…æ‹¬åˆ†æ:
    
    é¡§å®¢æƒ…å ±:
    - ä¼æ¥­å: ${customerData.customrName}
    - æ¥­ç•Œ: ${customerData.industryProfile.industry}
    - ä¼æ¥­è¦æ¨¡: ${customerData.companyProfile.employeeCount}å
    - åˆå›å¥‘ç´„æ—¥: ${customerData.firstProjectDate.toISOString()}
    - åˆå›æ¡ˆä»¶ä¾¡å€¤: ${customerData.projectHistory[0]?.value || 0}å††
    
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå±¥æ­´ (${customerData.projectHistory.length}ä»¶):
    ${customerData.projectHistory.map((project, index) => `
    ${index + 1}. ${project.title} (${project.value}å††)
       - æº€è¶³åº¦: ${project.satisfactionScore}/10
       - å®Œäº†æ—¥: ${project.completedAt?.toISOString()}
       - è¿½åŠ æ¡ˆä»¶: ${project.additionalWork ? 'ã‚ã‚Š' : 'ãªã—'}
    `).join('\n')}
    
    æº€è¶³åº¦æŒ‡æ¨™:
    - å¹³å‡æº€è¶³åº¦: ${customerData.satisfactionMetrics.averageScore}/10
    - æ¨è–¦æ„å‘: ${customerData.satisfactionMetrics.npsScore}
    - ãƒªãƒ”ãƒ¼ãƒˆç‡: ${customerData.satisfactionMetrics.repeatRate}%
    
    æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯:
    - æ¥­ç•Œå¹³å‡LTV: ${industryBenchmarks.averageLTV}å††
    - ç¶™ç¶šç‡: ${industryBenchmarks.continuationRate}%
    - å˜ä¾¡æˆé•·ç‡: ${industryBenchmarks.priceGrowthRate}%/å¹´
    
    éå»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ:
    ${historicalPerformance.trends.map(trend => `- ${trend}`).join('\n')}
    
    ä»¥ä¸‹ã®è¦ç´ ã‚’ç·åˆçš„ã«è€ƒæ…®ã—ã¦LTVåˆ†æã‚’å®Ÿè¡Œ:
    
    1. åŸºæœ¬LTVç®—å‡º:
       - åˆå›æ¡ˆä»¶ä¾¡å€¤ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–“éš”ã‹ã‚‰åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³äºˆæ¸¬
       - æº€è¶³åº¦ã¨ç¶™ç¶šç¢ºç‡ã®ç›¸é–¢åˆ†æ
       - ä¼æ¥­æˆé•·ã¨ç™ºæ³¨å¢—åŠ ã®å¯èƒ½æ€§
    
    2. å˜ä¾¡æˆé•·äºˆæ¸¬:
       - é–¢ä¿‚æ€§æ·±åŒ–ã«ã‚ˆã‚‹ä¾¡æ ¼å‘ä¸Šè¦‹è¾¼ã¿
       - æ¥­ç•Œãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ãƒˆãƒ¬ãƒ³ãƒ‰ã«ã‚ˆã‚‹éœ€è¦å¢—
       - ä¼æ¥­è¦æ¨¡æ‹¡å¤§ã«ä¼´ã†æ¡ˆä»¶è¦æ¨¡å‘ä¸Š
    
    3. ç´¹ä»‹ä¾¡å€¤ç®—å‡º:
       - æ¥­ç•Œã§ã®å½±éŸ¿åŠ›ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¦æ¨¡
       - æº€è¶³åº¦ã‹ã‚‰ã®ç´¹ä»‹ç¢ºç‡ç®—å‡º
       - ç´¹ä»‹æ¡ˆä»¶ã®å¹³å‡ä¾¡å€¤äºˆæ¸¬
    
    4. ãƒªã‚¹ã‚¯è¦å› åˆ†æ:
       - æ¥­ç•Œãƒˆãƒ¬ãƒ³ãƒ‰å¤‰åŒ–ãƒªã‚¹ã‚¯
       - ç«¶åˆä»–ç¤¾å‚å…¥ãƒªã‚¹ã‚¯
       - ä¼æ¥­å†…éƒ¨å¤‰åŒ–ãƒªã‚¹ã‚¯ï¼ˆæ‹…å½“è€…å¤‰æ›´ç­‰ï¼‰
       - çµŒæ¸ˆç’°å¢ƒå¤‰åŒ–ã¸ã®æ„Ÿåº¦
    
    5. æ©Ÿä¼šè¦å› åˆ†æ:
       - æ–°ã‚µãƒ¼ãƒ“ã‚¹ãƒ»æŠ€è¡“ã¸ã®éœ€è¦
       - æ¥­ç•Œå†…ã§ã®å£ã‚³ãƒŸãƒ»è©•åˆ¤åŠ¹æœ
       - é•·æœŸãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—ã®å¯èƒ½æ€§
    
    å›ç­”å½¢å¼:
    {
      "ltvCalculation": {
        "initialProjectValue": 1000000,
        "continuationProbability": 0.8,
        "averageProjectsPerYear": 2.0,
        "priceGrowthRate": 0.12,
        "relationshipDuration": 6,
        "referralProbability": 0.35,
        "referralAverageValue": 800000,
        "totalLTV": 5200000,
        "discountedLTV": 3800000,
        "discountRate": 0.1
      },
      "riskFactors": [
        "æ¥­ç•Œã®ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–é€²å±•ã«ã‚ˆã‚‹ç«¶åˆæ¿€åŒ–",
        "æ‹…å½“è€…å¤‰æ›´ã«ã‚ˆã‚‹é–¢ä¿‚æ€§ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯"
      ],
      "opportunities": [
        "AIãƒ»DXéœ€è¦æ‹¡å¤§ã«ã‚ˆã‚‹æ¡ˆä»¶å¢—åŠ æ©Ÿä¼š",
        "æ¥­ç•Œå†…ã§ã®æ¨è–¦ã«ã‚ˆã‚‹æ–°è¦é–‹æ‹“"
      ],
      "recommendedActions": [
        "å››åŠæœŸå®šæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã‚ˆã‚‹é–¢ä¿‚æ€§ç¶­æŒ",
        "æ–°æŠ€è¡“ãƒˆãƒ¬ãƒ³ãƒ‰æƒ…å ±ã®ç©æ¥µçš„å…±æœ‰"
      ],
      "confidenceLevel": 0.85,
      "comparisons": {
        "industryAverage": 3200000,
        "companyPerformance": "ABOVE"
      }
    }
    `);

    const result = this.parseLTVAnalysis(ltvAnalysis);
    
    // åˆ†æçµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
    await this.saveLTVAnalysis(connectionId, result);
    
    return result;
  }

  /**
   * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåç›Šäºˆæ¸¬
   */
  async predictProjectRevenue(
    projectId: string,
    baseContract: number,
    projectDetails: any
  ): Promise<{
    predictedRevenue: number;
    revenueBreakdown: any;
    confidenceInterval: { min: number; max: number };
    keyFactors: string[];
  }> {
    
    const project = await this.projectService.getProject(projectId);
    const historicalData = await this.getHistoricalProjectData(project);
    
    const revenueAnalysis = await this.aiService.evaluateWithGemini(`
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåç›Šäºˆæ¸¬åˆ†æ:
    
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æƒ…å ±:
    - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: ${project.title}
    - åŸºæœ¬å¥‘ç´„é¡: ${baseContract}å††
    - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé–“: ${project.duration}ãƒ¶æœˆ
    - è¤‡é›‘åº¦: ${project.complexity}/10
    - ãƒãƒ¼ãƒ è¦æ¨¡: ${project.teamSize}å
    
    é¡ä¼¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Ÿç¸¾:
    ${historicalData.similarProjects.map(p => `
    - ${p.title}: å¥‘ç´„é¡${p.contractValue}å†† â†’ æœ€çµ‚å£²ä¸Š${p.totalRevenue}å††
      è¿½åŠ ä½œæ¥­: ${p.additionalWorkValue}å††, ä¿å®ˆå¥‘ç´„: ${p.maintenanceValue}å††
    `).join('\n')}
    
    ä»¥ä¸‹ã®è¦ç´ ã‚’è€ƒæ…®ã—ã¦åç›Šäºˆæ¸¬:
    
    1. è¿½åŠ ä½œæ¥­ç™ºç”Ÿç¢ºç‡ãƒ»é‡‘é¡
       - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¤‡é›‘åº¦ã‹ã‚‰ã®è¿½åŠ ä½œæ¥­ãƒªã‚¹ã‚¯
       - é¡§å®¢ã®è¦æ±‚å¤‰æ›´å‚¾å‘
       - æŠ€è¡“çš„ä¸ç¢ºå®Ÿæ€§ã«ã‚ˆã‚‹è¿½åŠ å·¥æ•°
    
    2. ä¿å®ˆãƒ»é‹ç”¨å¥‘ç´„ã¸ã®è»¢æ›
       - å®Œæˆã‚·ã‚¹ãƒ†ãƒ ã®é‹ç”¨ã‚µãƒãƒ¼ãƒˆéœ€è¦
       - ç¶™ç¶šçš„æ”¹å–„ãƒ»æ©Ÿèƒ½è¿½åŠ ã®å¯èƒ½æ€§
       - é•·æœŸãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—ã®æ§‹ç¯‰
    
    3. é–¢é€£æ¡ˆä»¶ãƒ»ç´¹ä»‹ã®å‰µå‡º
       - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæˆåŠŸã«ã‚ˆã‚‹è¿½åŠ æ¡ˆä»¶
       - æ¥­ç•Œå†…ã§ã®è©•åˆ¤ãƒ»ç´¹ä»‹åŠ¹æœ
       - æŠ€è¡“ãƒã‚¦ãƒã‚¦ã®ä»–æ¡ˆä»¶ã¸ã®æ´»ç”¨
    
    å›ç­”å½¢å¼:
    {
      "predictedRevenue": 1800000,
      "revenueBreakdown": {
        "baseContract": 1000000,
        "additionalWork": 300000,
        "maintenanceContract": 400000,
        "referralValue": 100000
      },
      "confidenceInterval": {
        "min": 1400000,
        "max": 2200000
      },
      "keyFactors": [
        "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¤‡é›‘åº¦ãŒé«˜ãè¿½åŠ ä½œæ¥­ã®å¯èƒ½æ€§",
        "é¡§å®¢ã®ç¶™ç¶šåˆ©ç”¨æ„å‘ãŒå¼·ã„"
      ]
    }
    `);

    return this.parseRevenueAnalysis(revenueAnalysis);
  }

  /**
   * è²¡å‹™ãƒªã‚¹ã‚¯è©•ä¾¡
   */
  async assessFinancialRisk(
    projectId: string
  ): Promise<{
    riskLevel: 'LOW' | 'MEDIUM' | 'HIGH';
    riskFactors: Array<{
      factor: string;
      impact: number;
      probability: number;
      mitigation: string;
    }>;
    recommendedActions: string[];
    bufferRecommendation: number;
  }> {
    
    const project = await this.projectService.getProject(projectId);
    const financialDetails = await this.getProjectFinancialDetails(projectId);
    const teamAnalysis = await this.analyzeProjectTeam(projectId);
    
    const riskAnalysis = await this.aiService.evaluateWithGemini(`
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè²¡å‹™ãƒªã‚¹ã‚¯è©•ä¾¡:
    
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦:
    - å¥‘ç´„é¡: ${financialDetails.baseContractValue}å††
    - æœŸé–“: ${project.duration}ãƒ¶æœˆ
    - ãƒãƒ¼ãƒ æ§‹æˆ: ${teamAnalysis.teamComposition}
    - æŠ€è¡“é›£æ˜“åº¦: ${project.complexity}/10
    
    ã‚³ã‚¹ãƒˆæ§‹é€ :
    - ç›´æ¥äººä»¶è²»: ${financialDetails.directLaborCost}å††
    - é–“æ¥äººä»¶è²»: ${financialDetails.indirectLaborCost}å††
    - å¤–éƒ¨å§”è¨—è²»: ${financialDetails.externalContractorCost}å††
    - ãƒ„ãƒ¼ãƒ«ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©è²»: ${financialDetails.toolInfrastructureCost}å††
    
    ãƒãƒ¼ãƒ åˆ†æ:
    - çµŒé¨“ãƒ¬ãƒ™ãƒ«: ${teamAnalysis.experienceLevel}
    - æŠ€è¡“é©åˆåº¦: ${teamAnalysis.technicalFit}/10
    - å¯ç”¨æ€§: ${teamAnalysis.availability}%
    
    ä»¥ä¸‹ã®ãƒªã‚¹ã‚¯è¦å› ã‚’è©•ä¾¡:
    
    1. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒªã‚¹ã‚¯
       - æŠ€è¡“é›£æ˜“åº¦ã«ã‚ˆã‚‹é…å»¶å¯èƒ½æ€§
       - ãƒãƒ¼ãƒ ã®çµŒé¨“ãƒ»ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«
       - å¤–éƒ¨ä¾å­˜é–¢ä¿‚ã®è¤‡é›‘ã•
    
    2. å“è³ªãƒªã‚¹ã‚¯
       - è¦ä»¶ã®ä¸æ˜ç¢ºã•
       - ãƒ†ã‚¹ãƒˆãƒ»å“è³ªä¿è¨¼ã®å……å®Ÿåº¦
       - é¡§å®¢ã®é–¢ä¸ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é »åº¦
    
    3. ã‚¹ã‚³ãƒ¼ãƒ—ãƒªã‚¹ã‚¯
       - è¦æ±‚å¤‰æ›´ã®å¯èƒ½æ€§
       - ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã®åˆæ„åº¦
       - æŠ€è¡“çš„åˆ¶ç´„ã®ç†è§£åº¦
    
    4. ãƒªã‚½ãƒ¼ã‚¹ãƒªã‚¹ã‚¯
       - ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¢ã‚µã‚¤ãƒ³ç¢ºå®Ÿæ€§
       - å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®èª¿é”ãƒªã‚¹ã‚¯
       - ç«¶åˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã®ãƒªã‚½ãƒ¼ã‚¹ç«¶åˆ
    
    5. æŠ€è¡“ãƒªã‚¹ã‚¯
       - æ–°æŠ€è¡“ãƒ»æœªçµŒé¨“æŠ€è¡“ã®æ¡ç”¨
       - æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆè¤‡é›‘ã•
       - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£è¦ä»¶
    
    å›ç­”å½¢å¼:
    {
      "riskLevel": "MEDIUM",
      "riskFactors": [
        {
          "factor": "æ–°æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®æ¡ç”¨",
          "impact": 7,
          "probability": 0.4,
          "mitigation": "æŠ€è¡“èª¿æŸ»ãƒ•ã‚§ãƒ¼ã‚ºã®è¨­ç½®ã¨å°‚é–€å®¶ã‚³ãƒ³ã‚µãƒ«"
        }
      ],
      "recommendedActions": [
        "æŠ€è¡“çš„ä¸ç¢ºå®Ÿæ€§ã®æ—©æœŸè§£æ±º",
        "é¡§å®¢ã¨ã®å®šæœŸçš„ãªé€²æ—å…±æœ‰å¼·åŒ–"
      ],
      "bufferRecommendation": 0.2
    }
    `);

    return this.parseRiskAnalysis(riskAnalysis);
  }

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
  private async gatherCustomerData(connectionId: string): Promise<CustomerLTVData> {
    const connection = await this.connectionService.getConnection(connectionId);
    const projects = await this.getConnectionProjects(connectionId);
    const satisfaction = await this.getSatisfactionMetrics(connectionId);
    
    return {
      connectionId,
      customrName: connection.companyName,
      firstProjectDate: projects[0]?.createdAt || new Date(),
      projectHistory: projects.map(p => ({
        title: p.title,
        value: p.contractValue || 0,
        satisfactionScore: p.satisfactionScore || 8,
        completedAt: p.completedAt,
        additionalWork: p.additionalWorkValue > 0
      })),
      satisfactionMetrics: satisfaction,
      industryProfile: {
        industry: connection.industry || 'General',
        segment: connection.segment || 'SME'
      },
      companyProfile: {
        employeeCount: connection.employeeCount || 50,
        revenue: connection.annualRevenue || 0
      }
    };
  }

  private async getIndustryBenchmarks(industryProfile: any) {
    // æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ï¼‰
    const benchmarks = {
      'IT': { averageLTV: 3500000, continuationRate: 75, priceGrowthRate: 8 },
      'Manufacturing': { averageLTV: 2800000, continuationRate: 80, priceGrowthRate: 5 },
      'Healthcare': { averageLTV: 4200000, continuationRate: 85, priceGrowthRate: 12 },
      'General': { averageLTV: 3000000, continuationRate: 70, priceGrowthRate: 6 }
    };
    
    return benchmarks[industryProfile.industry] || benchmarks['General'];
  }

  private parseLTVAnalysis(aiResponse: string): LTVAnalysisResult {
    try {
      return JSON.parse(aiResponse);
    } catch (error) {
      console.error('LTV analysis parsing error:', error);
      return {
        ltvCalculation: {
          initialProjectValue: 0,
          continuationProbability: 0.5,
          averageProjectsPerYear: 1,
          priceGrowthRate: 0.05,
          relationshipDuration: 3,
          referralProbability: 0.1,
          referralAverageValue: 0,
          totalLTV: 0,
          discountedLTV: 0,
          discountRate: 0.1
        },
        riskFactors: ['AIå¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'],
        opportunities: ['æ‰‹å‹•ã§LTVåˆ†æã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„'],
        recommendedActions: ['ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦å†åˆ†æã—ã¦ãã ã•ã„'],
        confidenceLevel: 0.1,
        comparisons: {
          industryAverage: 0,
          companyPerformance: 'AVERAGE'
        }
      };
    }
  }

  private async saveLTVAnalysis(connectionId: string, analysis: LTVAnalysisResult) {
    const query = `
      INSERT INTO customer_ltv_analysis (
        connection_id, initial_project_value, continuation_probability,
        average_projects_per_year, price_growth_rate, relationship_duration_years,
        referral_probability, referral_average_value, total_ltv, discounted_ltv,
        risk_factors, opportunities, recommended_actions, confidence_score
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)
      ON CONFLICT (connection_id) DO UPDATE SET
        initial_project_value = EXCLUDED.initial_project_value,
        continuation_probability = EXCLUDED.continuation_probability,
        total_ltv = EXCLUDED.total_ltv,
        updated_at = NOW()
    `;
    
    await this.db.query(query, [
      connectionId,
      analysis.ltvCalculation.initialProjectValue,
      analysis.ltvCalculation.continuationProbability,
      analysis.ltvCalculation.averageProjectsPerYear,
      analysis.ltvCalculation.priceGrowthRate,
      analysis.ltvCalculation.relationshipDuration,
      analysis.ltvCalculation.referralProbability,
      analysis.ltvCalculation.referralAverageValue,
      analysis.ltvCalculation.totalLTV,
      analysis.ltvCalculation.discountedLTV,
      JSON.stringify(analysis.riskFactors),
      JSON.stringify(analysis.opportunities),
      JSON.stringify(analysis.recommendedActions),
      analysis.confidenceLevel
    ]);
  }
}
```

### **2.2 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ **

#### **2.2.1 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…**
```typescript
// src/services/ProjectTemplateGenerator.ts
import { AI_SERVICE } from './ai-service';

export interface EventTemplateRequest {
  eventType: 'CONFERENCE' | 'WORKSHOP' | 'SEMINAR' | 'NETWORKING' | 'COMPETITION';
  targetScale: number;
  budget: number;
  duration: number; // æ—¥æ•°
  location: 'ONLINE' | 'OFFLINE' | 'HYBRID';
  audience: string;
  objectives: string[];
}

export interface DevelopmentTemplateRequest {
  projectType: 'WEB_APP' | 'MOBILE_APP' | 'API' | 'SYSTEM_INTEGRATION' | 'AI_ML';
  complexity: number; // 1-10
  timeline: number; // é€±æ•°
  teamSize: number;
  technologies: string[];
  requirements: string[];
}

export interface GeneratedTemplate {
  projectName: string;
  description: string;
  phases: Array<{
    name: string;
    duration: string;
    tasks: Array<{
      title: string;
      description: string;
      estimatedHours: number;
      priority: 'A' | 'B' | 'C';
      dependencies: string[];
      skillRequirements: string[];
      deliverables: string[];
    }>;
  }>;
  budgetBreakdown: Record<string, number>;
  riskFactors: string[];
  successMetrics: string[];
  resources: {
    humanResources: string[];
    technicalResources: string[];
    externalServices: string[];
  };
}

export class ProjectTemplateGenerator {
  constructor(
    private aiService: typeof AI_SERVICE,
    private knowledgeService: any,
    private projectService: any
  ) {}

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
   */
  async generateEventTemplate(
    request: EventTemplateRequest
  ): Promise<GeneratedTemplate> {
    
    // é–¢é€£çŸ¥è­˜ãƒ»éå»äº‹ä¾‹ã®åé›†
    const relevantKnowledge = await this.knowledgeService.searchKnowledge({
      category: 'EVENT',
      tags: [request.eventType, `scale_${this.getScaleCategory(request.targetScale)}`],
      limit: 10
    });

    const historicalEvents = await this.getHistoricalEventData(request.eventType);
    
    const templateData = await this.aiService.evaluateWithGemini(`
    ã‚¤ãƒ™ãƒ³ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ:
    
    ã‚¤ãƒ™ãƒ³ãƒˆè¦ä»¶:
    - ã‚¿ã‚¤ãƒ—: ${request.eventType}
    - ç›®æ¨™è¦æ¨¡: ${request.targetScale}å
    - äºˆç®—: ${request.budget.toLocaleString()}å††
    - æœŸé–“: ${request.duration}æ—¥é–“
    - é–‹å‚¬å½¢å¼: ${request.location}
    - å¯¾è±¡ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹: ${request.audience}
    - ç›®çš„: ${request.objectives.join(', ')}
    
    éå»ã®çŸ¥è¦‹ãƒ»äº‹ä¾‹:
    ${relevantKnowledge.map(k => `
    - ${k.title}: ${k.content.substring(0, 200)}...
    `).join('\n')}
    
    é¡ä¼¼ã‚¤ãƒ™ãƒ³ãƒˆå®Ÿç¸¾:
    ${historicalEvents.map(event => `
    - ${event.name} (${event.scale}åè¦æ¨¡): äºˆç®—${event.budget}å††, æˆåŠŸåº¦${event.successScore}/10
    `).join('\n')}
    
    ä»¥ä¸‹ã®è¦ç´ ã‚’å«ã‚€åŒ…æ‹¬çš„ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ:
    
    1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚§ãƒ¼ã‚ºè¨­è¨ˆ
       - ä¼ç”»ãƒ»æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ2-4é€±é–“å‰ã‹ã‚‰ï¼‰
       - åºƒå ±ãƒ»é›†å®¢ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ3-6é€±é–“å‰ã‹ã‚‰ï¼‰
       - æº–å‚™ãƒ»åˆ¶ä½œãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ1-2é€±é–“å‰ï¼‰
       - å®Ÿæ–½ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå½“æ—¥ï¼‰
       - ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ1é€±é–“å¾Œã¾ã§ï¼‰
    
    2. å„ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚¿ã‚¹ã‚¯è©³ç´°
       - å…·ä½“çš„ãªä½œæ¥­å†…å®¹
       - å¿…è¦ã‚¹ã‚­ãƒ«ãƒ»æ‹…å½“è€…
       - å·¥æ•°è¦‹ç©ã‚‚ã‚Šï¼ˆéå»å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹ï¼‰
       - æˆæœç‰©ãƒ»ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
       - ä¾å­˜é–¢ä¿‚ãƒ»ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹
    
    3. äºˆç®—é…åˆ†
       - ä¼šå ´è²»ãƒ»è¨­å‚™è²»
       - è¬›å¸«ãƒ»ã‚²ã‚¹ãƒˆè²»
       - åºƒå ±ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è²»
       - é‹å–¶äººä»¶è²»
       - é›‘è²»ãƒ»äºˆå‚™è²»
    
    4. ãƒªã‚¹ã‚¯ç®¡ç†
       - é›†å®¢ä¸è¶³ãƒªã‚¹ã‚¯
       - æŠ€è¡“ãƒˆãƒ©ãƒ–ãƒ«ãƒªã‚¹ã‚¯
       - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é…å»¶ãƒªã‚¹ã‚¯
       - äºˆç®—è¶…éãƒªã‚¹ã‚¯
    
    5. æˆåŠŸæŒ‡æ¨™ãƒ»KPI
       - å‚åŠ è€…æ•°ãƒ»æº€è¶³åº¦
       - ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæŒ‡æ¨™
       - ROIãƒ»è²»ç”¨å¯¾åŠ¹æœ
       - ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—æˆæœ
    
    å›ç­”å½¢å¼:
    {
      "projectName": "${request.eventType}ã‚¤ãƒ™ãƒ³ãƒˆä¼ç”»ãƒ»é‹å–¶",
      "description": "è©³ç´°ãªèª¬æ˜",
      "phases": [
        {
          "name": "ä¼ç”»ãƒ•ã‚§ãƒ¼ã‚º",
          "duration": "2é€±é–“",
          "tasks": [
            {
              "title": "ã‚¤ãƒ™ãƒ³ãƒˆä¼ç”»æ›¸ä½œæˆ",
              "description": "ã‚¤ãƒ™ãƒ³ãƒˆã®ç›®çš„ãƒ»å†…å®¹ãƒ»é€²è¡Œã‚’è©³ç´°è¨­è¨ˆ",
              "estimatedHours": 16,
              "priority": "A",
              "dependencies": [],
              "skillRequirements": ["ä¼ç”»", "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³"],
              "deliverables": ["ä¼ç”»æ›¸", "é€²è¡Œå°æœ¬"]
            }
          ]
        }
      ],
      "budgetBreakdown": {
        "venue": 100000,
        "marketing": 80000,
        "speakers": 60000,
        "materials": 40000,
        "contingency": 20000
      },
      "riskFactors": ["é›†å®¢ä¸è¶³", "æŠ€è¡“ãƒˆãƒ©ãƒ–ãƒ«"],
      "successMetrics": ["å‚åŠ è€…æ•°100åä»¥ä¸Š", "æº€è¶³åº¦4.0ä»¥ä¸Š"],
      "resources": {
        "humanResources": ["ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼", "ãƒãƒ¼ã‚±ã‚¿ãƒ¼"],
        "technicalResources": ["é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ ", "å—ä»˜ã‚·ã‚¹ãƒ†ãƒ "],
        "externalServices": ["ä¼šå ´", "ã‚±ãƒ¼ã‚¿ãƒªãƒ³ã‚°"]
      }
    }
    `);

    return this.parseTemplate(templateData);
  }

  /**
   * é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
   */
  async generateDevelopmentTemplate(
    request: DevelopmentTemplateRequest
  ): Promise<GeneratedTemplate> {
    
    const technicalKnowledge = await this.getTechnicalKnowledge(request.technologies);
    const similarProjects = await this.getSimilarDevelopmentProjects(request);
    
    const templateData = await this.aiService.evaluateWithGemini(`
    é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ:
    
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦ä»¶:
    - ã‚¿ã‚¤ãƒ—: ${request.projectType}
    - è¤‡é›‘åº¦: ${request.complexity}/10
    - æœŸé–“: ${request.timeline}é€±é–“
    - ãƒãƒ¼ãƒ ã‚µã‚¤ã‚º: ${request.teamSize}å
    - æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: ${request.technologies.join(', ')}
    - è¦ä»¶: ${request.requirements.join(', ')}
    
    æŠ€è¡“çŸ¥è­˜ãƒ»ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹:
    ${technicalKnowledge.map(k => `
    - ${k.title}: ${k.content.substring(0, 150)}...
    `).join('\n')}
    
    é¡ä¼¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Ÿç¸¾:
    ${similarProjects.map(p => `
    - ${p.title}: ${p.duration}é€±é–“, æˆåŠŸåº¦${p.successScore}/10
    `).join('\n')}
    
    ä»¥ä¸‹ã®è¦ç´ ã‚’å«ã‚€é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ:
    
    1. é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºè¨­è¨ˆ
       - è¦ä»¶å®šç¾©ãƒ»è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚º
       - é–‹ç™ºãƒ»å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º
       - ãƒ†ã‚¹ãƒˆãƒ»å“è³ªä¿è¨¼ãƒ•ã‚§ãƒ¼ã‚º
       - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ãƒªãƒªãƒ¼ã‚¹ãƒ•ã‚§ãƒ¼ã‚º
       - é‹ç”¨ãƒ»ä¿å®ˆç§»è¡Œãƒ•ã‚§ãƒ¼ã‚º
    
    2. æŠ€è¡“çš„ã‚¿ã‚¹ã‚¯è©³ç´°
       - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
       - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
       - APIè¨­è¨ˆãƒ»å®Ÿè£…
       - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™º
       - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º
       - ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–
       - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
       - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    
    3. å“è³ªç®¡ç†ãƒ—ãƒ­ã‚»ã‚¹
       - ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹
       - ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ãƒ»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
       - ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
       - å“è³ªæŒ‡æ¨™ãƒ»é–¾å€¤
    
    4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†è¦ç´ 
       - ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¨­å®š
       - ãƒªã‚¹ã‚¯ç®¡ç†è¨ˆç”»
       - å¤‰æ›´ç®¡ç†ãƒ—ãƒ­ã‚»ã‚¹
       - ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ç®¡ç†
    
    å›ç­”å½¢å¼:
    {
      "projectName": "${request.projectType}é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ",
      "description": "è©³ç´°ãªé–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»",
      "phases": [
        {
          "name": "è¦ä»¶å®šç¾©ãƒ»è¨­è¨ˆ",
          "duration": "2é€±é–“",
          "tasks": [
            {
              "title": "è¦ä»¶å®šç¾©æ›¸ä½œæˆ",
              "description": "æ©Ÿèƒ½ãƒ»éæ©Ÿèƒ½è¦ä»¶ã®è©³ç´°å®šç¾©",
              "estimatedHours": 40,
              "priority": "A",
              "dependencies": [],
              "skillRequirements": ["è¦ä»¶å®šç¾©", "ã‚·ã‚¹ãƒ†ãƒ åˆ†æ"],
              "deliverables": ["è¦ä»¶å®šç¾©æ›¸", "ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸"]
            }
          ]
        }
      ],
      "budgetBreakdown": {
        "development": 1000000,
        "infrastructure": 200000,
        "thirdPartyServices": 150000,
        "testing": 100000,
        "contingency": 150000
      },
      "riskFactors": ["æŠ€è¡“çš„è¤‡é›‘ã•", "è¦ä»¶å¤‰æ›´"],
      "successMetrics": ["ç´æœŸéµå®ˆ", "å“è³ªåŸºæº–é”æˆ"],
      "resources": {
        "humanResources": ["ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰", "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢"],
        "technicalResources": ["é–‹ç™ºç’°å¢ƒ", "ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«"],
        "externalServices": ["ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹", "SaaSãƒ„ãƒ¼ãƒ«"]
      }
    }
    `);

    return this.parseTemplate(templateData);
  }

  /**
   * ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
   */
  async generateCustomTemplate(
    projectDescription: string,
    requirements: string[],
    constraints: string[]
  ): Promise<GeneratedTemplate> {
    
    const relatedKnowledge = await this.findRelatedKnowledge(projectDescription);
    
    const templateData = await this.aiService.evaluateWithGemini(`
    ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ:
    
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦:
    ${projectDescription}
    
    è¦ä»¶:
    ${requirements.map(req => `- ${req}`).join('\n')}
    
    åˆ¶ç´„æ¡ä»¶:
    ${constraints.map(constraint => `- ${constraint}`).join('\n')}
    
    é–¢é€£çŸ¥è­˜ãƒ»çµŒé¨“:
    ${relatedKnowledge.map(k => `
    - ${k.title}: ${k.content.substring(0, 100)}...
    `).join('\n')}
    
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ€§è³ªã‚’åˆ†æã—ã€æœ€é©ãªãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆã¨ã‚¿ã‚¹ã‚¯åˆ†è§£ã‚’è¡Œã†:
    
    1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç‰¹æ€§åˆ†æ
       - å‰µé€ æ€§ vs åˆ†ææ€§
       - å˜ç™º vs ç¶™ç¶šæ€§
       - å†…éƒ¨ vs å¤–éƒ¨é–¢ä¿‚è€…
       - æŠ€è¡“ vs ãƒ“ã‚¸ãƒã‚¹é‡ç‚¹
    
    2. é©åˆ‡ãªãƒ•ã‚§ãƒ¼ã‚ºè¨­è¨ˆ
       - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç‰¹æ€§ã«å¿œã˜ãŸãƒ•ã‚§ãƒ¼ã‚ºåˆ†å‰²
       - å„ãƒ•ã‚§ãƒ¼ã‚ºã®ç›®çš„ãƒ»æˆæœç‰©
       - ãƒ•ã‚§ãƒ¼ã‚ºé–“ã®ä¾å­˜é–¢ä¿‚
    
    3. ãƒªã‚¹ã‚¯ãƒ»åˆ¶ç´„ã¸ã®å¯¾ç­–
       - åˆ¶ç´„æ¡ä»¶ã‚’è€ƒæ…®ã—ãŸã‚¿ã‚¹ã‚¯è¨­è¨ˆ
       - ãƒªã‚¹ã‚¯è»½æ¸›ç­–ã®çµ„ã¿è¾¼ã¿
       - ä»£æ›¿æ¡ˆãƒ»ã‚³ãƒ³ãƒ†ã‚£ãƒ³ã‚¸ã‚§ãƒ³ã‚·ãƒ¼
    
    4. æˆåŠŸè¦å› ã®ç‰¹å®š
       - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæˆåŠŸã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼
       - æ¸¬å®šå¯èƒ½ãªæˆåŠŸæŒ‡æ¨™
       - ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼æº€è¶³åº¦æŒ‡æ¨™
    
    å›ç­”å½¢å¼: ä¸Šè¨˜ã®EventTemplateã€DevelopmentTemplateã¨åŒã˜å½¢å¼
    `);

    return this.parseTemplate(templateData);
  }

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
  private getScaleCategory(scale: number): string {
    if (scale < 50) return 'small';
    if (scale < 200) return 'medium';
    if (scale < 500) return 'large';
    return 'enterprise';
  }

  private async getHistoricalEventData(eventType: string) {
    const query = `
      SELECT title as name, participant_count as scale, 
             budget, success_score 
      FROM projects 
      WHERE project_type = 'EVENT' 
        AND tags::text LIKE '%${eventType}%'
        AND status = 'COMPLETED'
      ORDER BY created_at DESC 
      LIMIT 5
    `;
    const result = await this.db.query(query);
    return result.rows;
  }

  private async getTechnicalKnowledge(technologies: string[]) {
    const searchTerms = technologies.join(' OR ');
    return await this.knowledgeService.searchKnowledge({
      category: 'TECHNICAL',
      searchQuery: searchTerms,
      limit: 8
    });
  }

  private async getSimilarDevelopmentProjects(request: DevelopmentTemplateRequest) {
    const query = `
      SELECT title, duration, success_score
      FROM projects 
      WHERE project_type = $1 
        AND complexity_level BETWEEN $2 AND $3
        AND status = 'COMPLETED'
      ORDER BY created_at DESC 
      LIMIT 5
    `;
    const result = await this.db.query(query, [
      request.projectType,
      request.complexity - 1,
      request.complexity + 1
    ]);
    return result.rows;
  }

  private parseTemplate(aiResponse: string): GeneratedTemplate {
    try {
      return JSON.parse(aiResponse);
    } catch (error) {
      console.error('Template parsing error:', error);
      return {
        projectName: 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼',
        description: 'AIå¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ',
        phases: [{
          name: 'æ‰‹å‹•è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚º',
          duration: 'è¦æ¤œè¨',
          tasks: [{
            title: 'æ‰‹å‹•ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»ã‚’ä½œæˆ',
            description: 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ãŸãŸã‚ã€æ‰‹å‹•ã§è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„',
            estimatedHours: 8,
            priority: 'A',
            dependencies: [],
            skillRequirements: ['ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†'],
            deliverables: ['ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»æ›¸']
          }]
        }],
        budgetBreakdown: { total: 0 },
        riskFactors: ['ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆå¤±æ•—'],
        successMetrics: ['æ‰‹å‹•è¨ˆç”»ã®å®Œæˆ'],
        resources: {
          humanResources: ['ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼'],
          technicalResources: [],
          externalServices: []
        }
      };
    }
  }
}
```

### **2.3 ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ãƒŠãƒ¬ãƒƒã‚¸è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ **

#### **2.3.1 ãƒŠãƒ¬ãƒƒã‚¸è‡ªå‹•ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…**
```typescript
// src/services/TaskKnowledgeAutomator.ts
import { AI_SERVICE } from './ai-service';

export interface TaskCompletionData {
  taskId: string;
  completionData: {
    deliverables?: string;
    issues?: string;
    solutions?: string;
    lessonsLearned?: string;
    timeSpent: number;
    difficultyActual: number;
  };
}

export interface KnowledgeGenerationDecision {
  shouldGenerate: boolean;
  knowledgeTypes: ('TECHNICAL' | 'PROCESS' | 'BUSINESS' | 'PROBLEM_SOLVING')[];
  priority: 'HIGH' | 'MEDIUM' | 'LOW';
  suggestedTitle: string;
  keyPoints: string[];
  applicableScenarios: string[];
  estimatedValue: number; // 1-10
}

export interface GeneratedKnowledge {
  title: string;
  category: string;
  content: string;
  tags: string[];
  applicableProjects: string[];
  relatedTasks: string[];
  valueScore: number;
  confidence: number;
}

export class TaskKnowledgeAutomator {
  constructor(
    private aiService: typeof AI_SERVICE,
    private knowledgeService: any,
    private taskService: any
  ) {}

  /**
   * ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã®ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆåˆ¤å®šãƒ»å®Ÿè¡Œ
   */
  async processTaskCompletion(
    completionData: TaskCompletionData
  ): Promise<{
    decision: KnowledgeGenerationDecision;
    generatedKnowledge?: GeneratedKnowledge;
    processingTime: number;
  }> {
    
    const startTime = Date.now();
    
    // ã‚¿ã‚¹ã‚¯è©³ç´°æƒ…å ±ã‚’å–å¾—
    const task = await this.getTaskWithFullContext(completionData.taskId);
    
    // ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆåˆ¤å®š
    const decision = await this.evaluateKnowledgeGeneration(task, completionData.completionData);
    
    let generatedKnowledge: GeneratedKnowledge | undefined;
    
    if (decision.shouldGenerate) {
      generatedKnowledge = await this.generateKnowledge(task, completionData.completionData, decision);
      await this.saveGeneratedKnowledge(generatedKnowledge, task.id);
    }
    
    const processingTime = Date.now() - startTime;
    
    return {
      decision,
      generatedKnowledge,
      processingTime
    };
  }

  /**
   * ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆåˆ¤å®š
   */
  private async evaluateKnowledgeGeneration(
    task: any,
    completionData: any
  ): Promise<KnowledgeGenerationDecision> {
    
    const evaluation = await this.aiService.evaluateWithGemini(`
    ã‚¿ã‚¹ã‚¯å®Œäº†ãƒŠãƒ¬ãƒƒã‚¸åŒ–åˆ¤å®š:
    
    å®Œäº†ã‚¿ã‚¹ã‚¯è©³ç´°:
    - ã‚¿ã‚¤ãƒˆãƒ«: ${task.title}
    - èª¬æ˜: ${task.description || 'èª¬æ˜ãªã—'}
    - ã‚«ãƒ†ã‚´ãƒª: ${task.category || 'æœªåˆ†é¡'}
    - äºˆå®šå·¥æ•°: ${task.estimatedHours}æ™‚é–“
    - å®Ÿç¸¾å·¥æ•°: ${completionData.timeSpent}æ™‚é–“
    - å·¥æ•°ä¹–é›¢: ${((completionData.timeSpent - task.estimatedHours) / task.estimatedHours * 100).toFixed(1)}%
    - äºˆå®šé›£æ˜“åº¦: ${task.difficultyScore}/10
    - å®Ÿéš›é›£æ˜“åº¦: ${completionData.difficultyActual}/10
    - AIèª²é¡Œãƒ¬ãƒ™ãƒ«: ${task.aiIssueLevel || 'N/A'}
    
    å®Œäº†æ™‚ãƒ‡ãƒ¼ã‚¿:
    - æˆæœç‰©: ${completionData.deliverables || 'è¨˜éŒ²ãªã—'}
    - é­é‡ã—ãŸå•é¡Œ: ${completionData.issues || 'ãªã—'}
    - è§£æ±ºæ–¹æ³•: ${completionData.solutions || 'æ¨™æº–æ‰‹æ³•'}
    - å­¦ã‚“ã ã“ã¨: ${completionData.lessonsLearned || 'è¨˜éŒ²ãªã—'}
    
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ–‡è„ˆ:
    - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${task.project?.title || 'æœªåˆ†é¡'}
    - ãƒãƒ¼ãƒ : ${task.assignedTo || 'æœªå‰²å½“'}
    
    ä»¥ä¸‹ã®åŸºæº–ã§ãƒŠãƒ¬ãƒƒã‚¸åŒ–ä¾¡å€¤ã‚’è©•ä¾¡:
    
    1. å†åˆ©ç”¨ä¾¡å€¤ (é«˜ä¾¡å€¤æŒ‡æ¨™)
       - é¡ä¼¼ã‚¿ã‚¹ã‚¯ã§ã®æ´»ç”¨å¯èƒ½æ€§
       - æ‰‹æ³•ãƒ»ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ±ç”¨æ€§
       - ä½œæˆã—ãŸæˆæœç‰©ã®å†åˆ©ç”¨æ€§
       - è§£æ±ºã—ãŸå•é¡Œã®ä¸€èˆ¬æ€§
    
    2. å­¦ç¿’ä¾¡å€¤ (çŸ¥è­˜è“„ç©æŒ‡æ¨™) 
       - æ–°ã—ã„æŠ€è¡“ãƒ»æ‰‹æ³•ã®ç¿’å¾—
       - æ—¢å­˜æ‰‹æ³•ã®æ”¹å–„ãƒ»æœ€é©åŒ–
       - å¤±æ•—ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‹ã‚‰ã®å­¦ã³
       - ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ç™ºè¦‹
    
    3. åŠ¹ç‡åŒ–ä¾¡å€¤ (æ¥­å‹™æ”¹å–„æŒ‡æ¨™)
       - ä½œæ¥­æ™‚é–“çŸ­ç¸®ã«ã¤ãªãŒã‚‹çŸ¥è¦‹
       - å“è³ªå‘ä¸Šã«å¯„ä¸ã™ã‚‹æ‰‹æ³•
       - ã‚¨ãƒ©ãƒ¼ãƒ»ãƒªã‚¹ã‚¯å›é¿æ–¹æ³•
       - ãƒ—ãƒ­ã‚»ã‚¹æ”¹å–„ã®ãƒ’ãƒ³ãƒˆ
    
    4. å•é¡Œè§£æ±ºä¾¡å€¤ (èª²é¡Œå¯¾å¿œæŒ‡æ¨™)
       - ç‰¹æ®Šãƒ»è¤‡é›‘ãªå•é¡Œã®è§£æ±ºæ³•
       - å‰µé€ çš„ãƒ»é©æ–°çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
       - åˆ¶ç´„æ¡ä»¶ä¸‹ã§ã®å·¥å¤«
       - ä»£æ›¿æ¡ˆãƒ»å›é¿ç­–ã®ç™ºè¦‹
    
    åˆ¤å®šåŸºæº–:
    - HIGHä¾¡å€¤: 3ã¤ä»¥ä¸Šã®æŒ‡æ¨™ã§é«˜è©•ä¾¡ OR 1ã¤ã®æŒ‡æ¨™ã§æ¥µã‚ã¦é«˜ã„ä¾¡å€¤
    - MEDIUMä¾¡å€¤: 2ã¤ä»¥ä¸Šã®æŒ‡æ¨™ã§ä¸­ç¨‹åº¦ä»¥ä¸Šã®è©•ä¾¡
    - LOWä¾¡å€¤: 1ã¤ã®æŒ‡æ¨™ã§ä¸­ç¨‹åº¦ã®è©•ä¾¡
    - å¯¾è±¡å¤–: ã™ã¹ã¦ã®æŒ‡æ¨™ã§ä½è©•ä¾¡
    
    å›ç­”å½¢å¼:
    {
      "shouldGenerate": true,
      "knowledgeTypes": ["TECHNICAL", "PROBLEM_SOLVING"],
      "priority": "HIGH",
      "suggestedTitle": "React Hookæœ€é©åŒ–ã«ã‚ˆã‚‹æç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„æ‰‹æ³•",
      "keyPoints": [
        "useMemo/useCallbackã®åŠ¹æœçš„æ´»ç”¨",
        "ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç‰¹å®šæ–¹æ³•",
        "ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®å›é¿ç­–"
      ],
      "applicableScenarios": [
        "å¤§è¦æ¨¡Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™º",
        "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã®å³ã—ã„UIå®Ÿè£…"
      ],
      "estimatedValue": 8
    }
    `);

    return this.parseKnowledgeDecision(evaluation);
  }

  /**
   * ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆå®Ÿè¡Œ
   */
  private async generateKnowledge(
    task: any,
    completionData: any,
    decision: KnowledgeGenerationDecision
  ): Promise<GeneratedKnowledge> {
    
    const relatedKnowledge = await this.findRelatedKnowledge(task.title, task.description);
    const similarTasks = await this.findSimilarTasks(task);
    
    const generatedContent = await this.aiService.evaluateWithGemini(`
    ã‚¿ã‚¹ã‚¯å®Œäº†ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆ:
    
    åŸºæœ¬æƒ…å ±:
    - æ¨å¥¨ã‚¿ã‚¤ãƒˆãƒ«: ${decision.suggestedTitle}
    - ãƒŠãƒ¬ãƒƒã‚¸ã‚¿ã‚¤ãƒ—: ${decision.knowledgeTypes.join(', ')}
    - ä¾¡å€¤ãƒ¬ãƒ™ãƒ«: ${decision.priority}
    
    ã‚¿ã‚¹ã‚¯è©³ç´°:
    - ã‚¿ã‚¤ãƒˆãƒ«: ${task.title}
    - å®Ÿç¸¾å·¥æ•°: ${completionData.timeSpent}æ™‚é–“
    - å®Ÿéš›é›£æ˜“åº¦: ${completionData.difficultyActual}/10
    - æˆæœç‰©: ${completionData.deliverables}
    - å•é¡Œãƒ»è§£æ±ºæ³•: ${completionData.issues} â†’ ${completionData.solutions}
    - å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ: ${completionData.lessonsLearned}
    
    é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
    ${decision.keyPoints.map(point => `- ${point}`).join('\n')}
    
    é©ç”¨å ´é¢:
    ${decision.applicableScenarios.map(scenario => `- ${scenario}`).join('\n')}
    
    é–¢é€£æ—¢å­˜ãƒŠãƒ¬ãƒƒã‚¸:
    ${relatedKnowledge.map(k => `- ${k.title}`).join('\n')}
    
    é¡ä¼¼ã‚¿ã‚¹ã‚¯äº‹ä¾‹:
    ${similarTasks.map(t => `- ${t.title} (${t.actualHours}h)`).join('\n')}
    
    ä»¥ä¸‹ã®æ§‹æˆã§å®Ÿç”¨çš„ãªãƒŠãƒ¬ãƒƒã‚¸è¨˜äº‹ã‚’ç”Ÿæˆ:
    
    1. æ¦‚è¦ãƒ»èƒŒæ™¯
       - ä½•ã‚’è§£æ±º/é”æˆã—ãŸã‹
       - ãªãœã“ã®æ‰‹æ³•ãŒå¿…è¦ã ã£ãŸã‹
       - å¾“æ¥æ‰‹æ³•ã¨ã®é•ã„ãƒ»æ”¹å–„ç‚¹
    
    2. å…·ä½“çš„ãªæ‰‹æ³•ãƒ»ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
       - ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã®å®Ÿè¡Œæ–¹æ³•
       - ä½¿ç”¨ã—ãŸãƒ„ãƒ¼ãƒ«ãƒ»æŠ€è¡“ãƒ»ãƒªã‚½ãƒ¼ã‚¹
       - é‡è¦ãªåˆ¤æ–­ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚³ãƒ„
    
    3. é­é‡ã—ãŸå•é¡Œã¨è§£æ±ºç­–
       - ç™ºç”Ÿã—ãŸèª²é¡Œãƒ»éšœå®³
       - è©¦è¡ŒéŒ¯èª¤ã®ãƒ—ãƒ­ã‚»ã‚¹
       - æœ€çµ‚çš„ãªè§£æ±ºæ–¹æ³•ãƒ»å›é¿ç­–
    
    4. æˆæœãƒ»åŠ¹æœ
       - é”æˆã—ãŸçµæœãƒ»å“è³ª
       - æ™‚é–“ãƒ»ã‚³ã‚¹ãƒˆãƒ»å“è³ªã¸ã®å½±éŸ¿
       - å‰¯æ¬¡çš„ãªåŠ¹æœãƒ»å­¦ã³
    
    5. é©ç”¨æŒ‡é‡ãƒ»æ³¨æ„ç‚¹
       - ã©ã†ã„ã†å ´é¢ã§ä½¿ãˆã‚‹ã‹
       - é©ç”¨æ™‚ã®å‰ææ¡ä»¶ãƒ»åˆ¶ç´„
       - æ³¨æ„ã™ã¹ããƒã‚¤ãƒ³ãƒˆãƒ»è½ã¨ã—ç©´
    
    6. ä»Šå¾Œã®ç™ºå±•ãƒ»æ”¹å–„å¯èƒ½æ€§
       - ã•ã‚‰ãªã‚‹æœ€é©åŒ–ã®ä½™åœ°
       - ä»–ã®æ‰‹æ³•ã¨ã®çµ„ã¿åˆã‚ã›
       - æŠ€è¡“ç™ºå±•ã«ä¼´ã†é€²åŒ–å¯èƒ½æ€§
    
    å›ç­”å½¢å¼:
    {
      "title": "ç”Ÿæˆã•ã‚ŒãŸãƒŠãƒ¬ãƒƒã‚¸ã‚¿ã‚¤ãƒˆãƒ«",
      "category": "TECHNICAL",
      "content": "# æ¦‚è¦\\n\\nè©³ç´°ãªå†…å®¹...",
      "tags": ["React", "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹", "æœ€é©åŒ–"],
      "applicableProjects": ["Webã‚¢ãƒ—ãƒªé–‹ç™º", "UIæ”¹å–„"],
      "relatedTasks": ["task123", "task456"],
      "valueScore": 8,
      "confidence": 0.9
    }
    `);

    return this.parseGeneratedKnowledge(generatedContent);
  }

  /**
   * é–¢é€£ã‚¿ã‚¹ã‚¯è‡ªå‹•æ›´æ–°
   */
  async updateRelatedTasksWithKnowledge(
    knowledgeId: string,
    knowledge: GeneratedKnowledge
  ): Promise<void> {
    
    // é–¢é€£ã‚¿ã‚¹ã‚¯ã‚’ç‰¹å®š
    const relatedTasks = await this.findTasksForKnowledgeApplication(knowledge);
    
    for (const task of relatedTasks) {
      // ã‚¿ã‚¹ã‚¯ã«ãƒŠãƒ¬ãƒƒã‚¸ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
      await this.linkKnowledgeToTask(task.id, knowledgeId);
      
      // å·¥æ•°ãƒ»é›£æ˜“åº¦ã®å†è©•ä¾¡ã‚’ææ¡ˆ
      const updatedEstimate = await this.suggestTaskUpdates(task, knowledge);
      if (updatedEstimate.shouldUpdate) {
        await this.proposeTaskUpdates(task.id, updatedEstimate);
      }
    }
  }

  /**
   * ãƒŠãƒ¬ãƒƒã‚¸å“è³ªè©•ä¾¡ãƒ»æ”¹å–„
   */
  async evaluateKnowledgeQuality(
    knowledgeId: string
  ): Promise<{
    qualityScore: number;
    improvementSuggestions: string[];
    usageTracking: {
      viewCount: number;
      applicationCount: number;
      feedback: any[];
    };
  }> {
    
    const knowledge = await this.knowledgeService.getKnowledge(knowledgeId);
    const usageData = await this.getKnowledgeUsageData(knowledgeId);
    const feedback = await this.getKnowledgeFeedback(knowledgeId);
    
    const qualityEvaluation = await this.aiService.evaluateWithGemini(`
    ãƒŠãƒ¬ãƒƒã‚¸å“è³ªè©•ä¾¡:
    
    ãƒŠãƒ¬ãƒƒã‚¸å†…å®¹:
    - ã‚¿ã‚¤ãƒˆãƒ«: ${knowledge.title}
    - ã‚«ãƒ†ã‚´ãƒª: ${knowledge.category}
    - ä½œæˆæ—¥: ${knowledge.createdAt}
    - å†…å®¹é•·: ${knowledge.content.length}æ–‡å­—
    
    åˆ©ç”¨çŠ¶æ³:
    - é–²è¦§å›æ•°: ${usageData.viewCount}å›
    - å®Ÿéš›æ´»ç”¨å›æ•°: ${usageData.applicationCount}å›
    - æ´»ç”¨ç‡: ${(usageData.applicationCount / Math.max(usageData.viewCount, 1) * 100).toFixed(1)}%
    
    ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:
    ${feedback.map(f => `- ${f.rating}/5: ${f.comment}`).join('\n')}
    
    ä»¥ä¸‹ã®åŸºæº–ã§å“è³ªè©•ä¾¡:
    
    1. å®Ÿç”¨æ€§ãƒ»æœ‰ç”¨æ€§ (40%)
       - å®Ÿéš›ã«å•é¡Œè§£æ±ºã«å½¹ç«‹ã¤ã‹
       - æ‰‹æ³•ãƒ»ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®å…·ä½“æ€§
       - é©ç”¨å ´é¢ã®æ˜ç¢ºã•
    
    2. ç†è§£ã—ã‚„ã™ã•ãƒ»å†ç¾æ€§ (30%)
       - èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•
       - æ‰‹é †ã®å†ç¾å¯èƒ½æ€§
       - å¿…è¦ãªå‰æçŸ¥è­˜ã®é©åˆ‡æ€§
    
    3. å®Œå…¨æ€§ãƒ»ç¶²ç¾…æ€§ (20%)
       - æƒ…å ±ã®åŒ…æ‹¬æ€§
       - æ³¨æ„ç‚¹ãƒ»åˆ¶ç´„ã®è¨˜è¿°
       - é–¢é€£æƒ…å ±ã¨ã®é€£æº
    
    4. æœ€æ–°æ€§ãƒ»æ­£ç¢ºæ€§ (10%)
       - æƒ…å ±ã®æ–°ã—ã•ãƒ»å¦¥å½“æ€§
       - æŠ€è¡“ãƒ»æ‰‹æ³•ã®ç¾çŠ¶é©åˆæ€§
       - ã‚¨ãƒ©ãƒ¼ãƒ»èª¤æƒ…å ±ã®æœ‰ç„¡
    
    ç·åˆã‚¹ã‚³ã‚¢ç®—å‡ºã¨æ”¹å–„ææ¡ˆ:
    
    å›ç­”å½¢å¼:
    {
      "qualityScore": 7.5,
      "improvementSuggestions": [
        "å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ä¾‹ã®è¿½åŠ ",
        "é©ç”¨æ¡ä»¶ã‚’ã‚ˆã‚Šæ˜ç¢ºã«è¨˜è¿°"
      ]
    }
    `);

    const evaluation = this.parseQualityEvaluation(qualityEvaluation);
    
    return {
      ...evaluation,
      usageTracking: {
        viewCount: usageData.viewCount,
        applicationCount: usageData.applicationCount,
        feedback: feedback
      }
    };
  }

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
  private async getTaskWithFullContext(taskId: string) {
    const query = `
      SELECT t.*, p.title as project_title, u.name as assignee_name
      FROM tasks t
      LEFT JOIN projects p ON t.project_id = p.id
      LEFT JOIN users u ON t.assigned_to = u.id
      WHERE t.id = $1
    `;
    const result = await this.db.query(query, [taskId]);
    return result.rows[0];
  }

  private parseKnowledgeDecision(aiResponse: string): KnowledgeGenerationDecision {
    try {
      return JSON.parse(aiResponse);
    } catch (error) {
      return {
        shouldGenerate: false,
        knowledgeTypes: [],
        priority: 'LOW',
        suggestedTitle: 'AIå¿œç­”è§£æã‚¨ãƒ©ãƒ¼',
        keyPoints: ['æ‰‹å‹•ã§ãƒŠãƒ¬ãƒƒã‚¸åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„'],
        applicableScenarios: [],
        estimatedValue: 1
      };
    }
  }

  private parseGeneratedKnowledge(aiResponse: string): GeneratedKnowledge {
    try {
      return JSON.parse(aiResponse);
    } catch (error) {
      return {
        title: 'ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆã‚¨ãƒ©ãƒ¼',
        category: 'GENERAL',
        content: 'AIå¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒŠãƒ¬ãƒƒã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚',
        tags: ['error'],
        applicableProjects: [],
        relatedTasks: [],
        valueScore: 1,
        confidence: 0.1
      };
    }
  }

  private async saveGeneratedKnowledge(knowledge: GeneratedKnowledge, sourceTaskId: string) {
    const query = `
      INSERT INTO knowledge_items (
        title, category, content, tags, 
        auto_generated, source_type, source_document_id,
        value_score, confidence_score, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW())
      RETURNING id
    `;
    
    const result = await this.db.query(query, [
      knowledge.title,
      knowledge.category,
      knowledge.content,
      JSON.stringify(knowledge.tags),
      true,
      'TASK_COMPLETION',
      sourceTaskId,
      knowledge.valueScore,
      knowledge.confidence
    ]);
    
    return result.rows[0].id;
  }
}
```

---

## ğŸ§ª **Phase 2 ãƒ†ã‚¹ãƒˆè¨ˆç”»**

### **2.1 å˜ä½“ãƒ†ã‚¹ãƒˆ**
```typescript
// __tests__/CustomerLTVAnalyzer.test.ts
describe('CustomerLTVAnalyzer', () => {
  test('calculateComprehensiveLTV should return valid analysis', async () => {
    const analyzer = new CustomerLTVAnalyzer();
    const connectionId = 'test-connection-1';
    
    const result = await analyzer.calculateComprehensiveLTV(connectionId);
    
    expect(result.ltvCalculation.totalLTV).toBeGreaterThan(0);
    expect(result.confidenceLevel).toBeGreaterThan(0);
    expect(result.riskFactors).toBeInstanceOf(Array);
  });
});

// __tests__/ProjectTemplateGenerator.test.ts
describe('ProjectTemplateGenerator', () => {
  test('generateEventTemplate should create valid template', async () => {
    const generator = new ProjectTemplateGenerator();
    const request = {
      eventType: 'CONFERENCE',
      targetScale: 100,
      budget: 500000,
      duration: 1,
      location: 'OFFLINE',
      audience: 'IT professionals',
      objectives: ['networking', 'knowledge sharing']
    };
    
    const template = await generator.generateEventTemplate(request);
    
    expect(template.phases.length).toBeGreaterThan(0);
    expect(template.budgetBreakdown).toBeTruthy();
  });
});
```

---

## ğŸ“Š **Phase 2 æˆåŠŸæŒ‡æ¨™**

### **2.1 å®šé‡æŒ‡æ¨™**
- [ ] **LTVäºˆæ¸¬ç²¾åº¦**: å®Ÿç¸¾ã¨ã®ä¹–é›¢ Â±20%ä»¥å†…
- [ ] **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆæ™‚é–“**: < 30ç§’
- [ ] **ãƒŠãƒ¬ãƒƒã‚¸è‡ªå‹•ç”Ÿæˆç‡**: å®Œäº†ã‚¿ã‚¹ã‚¯ã® 30%ä»¥ä¸Š
- [ ] **API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: < 1ç§’

### **2.2 æ©Ÿèƒ½æŒ‡æ¨™**
- [ ] **è²¡å‹™åˆ†æç²¾åº¦**: éå»ãƒ‡ãƒ¼ã‚¿ã¨ã®æ•´åˆæ€§ 90%
- [ ] **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®Ÿç”¨æ€§**: ç”Ÿæˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®åˆ©ç”¨ç‡ 70%
- [ ] **ãƒŠãƒ¬ãƒƒã‚¸å“è³ª**: è‡ªå‹•ç”ŸæˆãƒŠãƒ¬ãƒƒã‚¸ã®è©•ä¾¡ 7/10ä»¥ä¸Š

---

## âš ï¸ **Phase 2 æ³¨æ„äº‹é …**

### **2.1 ãƒ‡ãƒ¼ã‚¿ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
- è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–å¿…é ˆ
- é¡§å®¢æƒ…å ±ã®é©åˆ‡ãªåŒ¿ååŒ–
- ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®å³æ ¼ãªç®¡ç†

### **2.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
- AIå‡¦ç†ã®éåŒæœŸåŒ–
- å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®æœ€é©åŒ–
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®å®Ÿè£…

---

**Phase 2 å®Œäº†åŸºæº–**: å…¨æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆé€šéã€å“è³ªæŒ‡æ¨™é”æˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†