# LINEボット重複コード解消・リファクタリング計画書

## 📋 計画概要

**目的**: typeMap・convertPriority等の重複コード解消とアーキテクチャ改善  
**手法**: 手動LINEテスト + 段階的リファクタリング  
**期間**: 3-5フェーズ（各フェーズごとに全機能テスト実施）

---

## 🎯 現状分析結果

### 🔍 発見された問題

#### 1️⃣ 緊急修正済み
- ✅ **「📝 データ」表示問題**: route.ts:813のtypeMapに`appointment`キー欠落 → 修正済み

#### 2️⃣ 重複コード一覧
- **typeMap重複**: 5箇所で同じマッピング定義
- **convertPriority重複**: 2箇所で同じ変換ロジック
- **notification.ts肥大化**: 2092行の巨大ファイル

---

## 🧪 テスト戦略

### 手動テスト方式
- **実行環境**: ローカルサーバー + ngrok + LINE実機
- **テスト実行者**: プロジェクトオーナー
- **ログ確認者**: エンジニア
- **テストタイミング**: 各リファクタリングフェーズ後

### 📱 必須テストケース一覧

#### A. 基本データ登録テスト
1. **個人予定**: 「明日の14時に歯医者」
2. **タスク**: 「プレゼン資料作成、優先度高」  
3. **アポイントメント**: 「田中さんとの打ち合わせ、来週月曜日15時」
4. **プロジェクト**: 「新商品開発プロジェクト開始」
5. **人脈**: 「佐藤さん、営業部長、携帯090-1234-5678」
6. **メモ**: 「会議で出たアイデア：顧客満足度向上施策」

#### B. LINEメニュー操作テスト
1. **分類確認**: 正しいアイコンとテキスト表示
2. **再分類**: メニューから別タイプに変更
3. **詳細入力**: 各種フィールド入力
4. **完了通知**: 保存完了メッセージの確認

#### C. エラーケーステスト  
1. **不明な入力**: 意味不明なテキスト送信
2. **セッション競合**: 複数データ同時入力
3. **タイムアウト**: 長時間放置後の操作

---

## 🚀 段階的リファクタリング計画

### ✅ Phase 1: 共通定数ファイル作成【完了】
**目標**: typeMapとconvertPriorityの統一
**完了日**: 2025-06-18 (コミット: 61820fa)

#### 実装手順
1. **共通定数ファイル作成**
   ```typescript
   // src/lib/constants/line-types.ts
   export const TYPE_MAP = {
     personal_schedule: '📅 予定',
     schedule: '🎯 イベント',
     task: '📋 タスク', 
     project: '📊 プロジェクト',
     contact: '👤 人脈',
     appointment: '📅 アポイントメント',
     memo: '📝 メモ・ナレッジ'
   };
   ```

2. **convertPriority統一**
   ```typescript
   // src/lib/utils/line-helpers.ts
   export function convertPriority(priority: string): 'A' | 'B' | 'C' | 'D'
   ```

3. **各ファイルで共通定数をimport**

#### 📱 Phase 1 テスト指示
```
🧪 テストケース: 全データタイプの登録と表示確認

【テスト手順】
1. ローカルサーバー起動: npm run dev
2. ngrok起動: npm run line:ngrok  
3. 以下を順番にLINEで送信し、表示を確認:
   - 「明日14時に歯医者」(個人予定)
   - 「プレゼン資料作成」(タスク)
   - 「田中さんとの会議」(アポイントメント)
   - 「新プロジェクト開始」(プロジェクト)
   - 「佐藤さん 090-1234-5678」(人脈)
   - 「重要なメモ内容」(メモ)

【確認ポイント】
✅ 分類確認メッセージで正しいアイコン表示
✅ 保存完了で正しいタイプ名表示  
✅ 「📝 データ」が表示されないこと
✅ ログにエラーが出ないこと
```

---

### ✅ Phase 2: notification.ts分割【完了】
**目標**: 巨大ファイルの責任分離
**完了日**: 2025-06-19 (コミット: 622d9cc)

#### ✅ 分割結果（完了）
```
notification.ts (2,055行) → 95行 (95%削減)
↓
├── line-messages.ts (173行) - 基本メッセージ生成
├── line-flex-ui.ts (740行) - Flexメッセージ・UI生成  
├── line-sender.ts (246行) - 送信・通信機能
└── line-menu.ts (736行) - メニュー・フォーム生成

【達成内容】
✅ 単一責任原則: 各ファイルが明確な役割
✅ 依存関係整理: 循環参照なし
✅ 保守性向上: 機能追加・修正が容易
✅ テスト性向上: 個別機能テスト可能
✅ 後方互換性: 既存route.ts修正不要
✅ 品質確認: ビルド成功・型エラー修正済み
```

#### 📱 Phase 2 テスト指示（次のエンジニア実行予定）
```
🧪 テストケース: 全メニュー機能の動作確認

【テスト手順】
1. 「タスク登録お願いします」送信
2. 分類確認で「📋 確定」押下
3. 「📝 詳細入力」押下  
4. 各フィールド入力テスト
5. 「🔄 再分類」押下
6. 完了まで一連の流れ確認

【確認ポイント】  
✅ 全ボタンが正常動作
✅ フィールド入力が保存される
✅ 再分類が機能する
✅ 完了通知が正しく表示

【実装状況】
✅ コード分割完了
✅ ビルド成功確認済み
⏳ 手動LINEテスト待ち
```

---

### Phase 3: route.tsの責任分離【中優先】
**目標**: Webhook処理の整理

#### 分離計画
```
route.ts (1465行)
↓  
├── webhook-handler.ts (メイン処理)
├── session-processor.ts (セッション管理)
├── data-saver.ts (DB保存処理)
└── postback-processor.ts (ボタン処理)
```

#### 📱 Phase 3 テスト指示  
```
🧪 テストケース: セッション管理と並行処理

【テスト手順】
1. 複数メッセージ連続送信
2. セッション中断・再開テスト
3. 異なるユーザーからの同時アクセス
4. エラー条件での動作確認

【確認ポイント】
✅ セッション状態が正しく管理される
✅ データ競合が発生しない  
✅ エラー時の適切な回復
✅ 全ユーザーで独立動作
```

---

### Phase 4: エラーハンドリング強化【低優先】
**目標**: 堅牢性向上

#### 📱 Phase 4 テスト指示
```
🧪 テストケース: エラー条件とエッジケース

【テスト手順】  
1. 無効なテキスト送信: 「あああああ」
2. 超長文送信: 1000文字以上
3. 特殊文字送信: 絵文字・記号
4. 高速連続送信: 10回連続
5. セッションタイムアウト後操作

【確認ポイント】
✅ エラーメッセージが適切
✅ システムクラッシュしない
✅ セッション状態が適切にリセット
✅ ログに異常がない
```

---

### Phase 5: 最終統合テスト【必須】
**目標**: 全機能の総合動作確認

#### 📱 Phase 5 テスト指示
```
🧪 テストケース: 全機能統合テスト

【テスト手順】
Phase 1-4の全テストケースを順番に実行

【成功判定基準】
✅ 全データタイプが正しく登録・表示
✅ 全メニュー機能が正常動作  
✅ エラーケースが適切に処理
✅ パフォーマンスに問題なし
✅ ログにエラー・警告がない
```

---

## 🔧 各フェーズの作業手順

### エンジニア作業フロー
1. **コード修正実施**
2. **ローカル動作確認**  
3. **テスト指示書提供**
4. **プロジェクトオーナーによるLINEテスト実行**
5. **ログ解析・問題修正**
6. **次フェーズへ進行判定**

### テスト失敗時の対応
1. **ログ収集**: `tail -f webhook.log`
2. **問題分析**: エラー箇所特定
3. **修正実施**: 最小限の変更
4. **再テスト**: 同一ケース再実行
5. **成功確認**: 次フェーズへ

---

## 📊 進捗管理

### 完了判定基準
- [x] Phase 1: 全データタイプ正常表示 ✅ **完了 (2025-06-18)**
- [x] Phase 2: 全メニュー機能動作 ✅ **実装完了・テスト待ち (2025-06-19)**  
- [ ] Phase 3: セッション管理安定
- [ ] Phase 4: エラーハンドリング完備
- [ ] Phase 5: 統合テスト成功

### 品質チェックポイント
1. **機能性**: 全機能が仕様通り動作
2. **安定性**: エラー時も適切に回復
3. **保守性**: コード重複が解消
4. **可読性**: ファイル分割で理解しやすい

---

## 🚨 緊急時対応

### ロールバック手順
1. **gitステータス確認**: `git status`
2. **変更取り消し**: `git checkout -- .`  
3. **動作確認**: 元の状態でテスト
4. **問題分析**: 何が原因だったか調査

### エスカレーション条件
- 修正後にシステムが動作しない
- データ損失の可能性がある
- 3回連続でテストが失敗する

---

## 📝 次のエンジニアへの引き継ぎ事項

### 作業開始前の確認
1. **環境セットアップ**: ngrok・LINEボット設定
2. **ベースライン確認**: 現在の動作をテスト
3. **git管理**: 各Phase前にコミット作成

### Phase完了時の作業
1. **テスト結果記録**: ログとスクリーンショット
2. **コミット作成**: 明確なメッセージで保存
3. **次Phase準備**: 必要なファイル・環境確認

このリファクタリング計画により、コードの重複解消と保守性向上を段階的かつ安全に実現します。