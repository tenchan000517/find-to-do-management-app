# Phase 4: å–¶æ¥­ãƒ»ã‚¢ãƒã‚¤ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  å®Ÿè£…è¨ˆç”»æ›¸

**ãƒ•ã‚§ãƒ¼ã‚ºæœŸé–“**: 5æ—¥é–“  
**å®Ÿè£…æ—¥**: 2025å¹´7æœˆ9æ—¥ ã€œ 2025å¹´7æœˆ13æ—¥  
**æ‹…å½“ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢**: å–¶æ¥­ã‚·ã‚¹ãƒ†ãƒ æ‹…å½“  
**å‰ææ¡ä»¶**: Phase 1-3å®Œäº†ã€æ—¢å­˜å–¶æ¥­ãƒ»ã‚¢ãƒã‚¤ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½ã®ç†è§£

---

## ğŸ¯ **Phase 4 å®Ÿè£…ç›®æ¨™**

### **4.1 ä¸»è¦æ©Ÿèƒ½å®Ÿè£…**
- **LINE/Discord UI/UXå¼·åŒ–**: è‡ªç„¶è¨€èªå‡¦ç†ã«ã‚ˆã‚‹æ“ä½œè‡ªå‹•åŒ–ï¼ˆ80%ç›®æ¨™ï¼‰
- **å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹å®Œå…¨è‡ªå‹•åŒ–**: ã‚¢ãƒã‚¤ãƒ³ãƒˆâ†’å¥‘ç´„â†’ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹é€£æºã®å…¨è‡ªå‹•åŒ–
- **AIå–¶æ¥­ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ**: é¡§å®¢åˆ†æãƒ»ææ¡ˆç”Ÿæˆãƒ»äº¤æ¸‰æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ 
- **æˆç´„ç¢ºç‡ã‚¨ãƒ³ã‚¸ãƒ³**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æˆç´„ç¢ºç‡ç®—å‡ºãƒ»æœ€é©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ

### **4.2 æŠ€è¡“è¦ä»¶**
- æ—¢å­˜å–¶æ¥­ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®é«˜åº¦åŒ–
- è‡ªç„¶è¨€èªå‡¦ç†ã®ç²¾åº¦å‘ä¸Š
- LINE/Discord APIçµ±åˆå¼·åŒ–
- AIæ”¯æ´å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹ã®å®Œå…¨å®Ÿè£…

---

## ğŸ“‹ **Phase 4 å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

### **4.1 LINE/Discordè‡ªç„¶è¨€èªå‡¦ç†å¼·åŒ– (2æ—¥)**
- [ ] é«˜åº¦è‡ªç„¶è¨€èªå‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…
- [ ] æ„å›³èªè­˜ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ 
- [ ] ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç†è§£ãƒ»ç¶™ç¶šå¯¾è©±æ©Ÿèƒ½
- [ ] éŸ³å£°ãƒ»ç”»åƒèªè­˜çµ±åˆ

### **4.2 å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ  (2æ—¥)**
- [ ] ã‚¢ãƒã‚¤ãƒ³ãƒˆè‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
- [ ] å¥‘ç´„å‡¦ç†è‡ªå‹•åŒ–ã‚¨ãƒ³ã‚¸ãƒ³
- [ ] ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹ã‚¿ã‚¹ã‚¯è‡ªå‹•ç”Ÿæˆ
- [ ] ãƒŠãƒ¬ãƒƒã‚¸è‡ªå‹•è“„ç©ã‚·ã‚¹ãƒ†ãƒ 

### **4.3 AIå–¶æ¥­ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ (0.5æ—¥)**
- [ ] é¡§å®¢åˆ†æãƒ»ã‚¤ãƒ³ã‚µã‚¤ãƒˆç”Ÿæˆ
- [ ] ææ¡ˆæ›¸è‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½
- [ ] äº¤æ¸‰æˆ¦ç•¥ææ¡ˆã‚·ã‚¹ãƒ†ãƒ 
- [ ] æˆç´„æœ€é©åŒ–ã‚¨ãƒ³ã‚¸ãƒ³

### **4.4 æˆç´„ç¢ºç‡ã‚¨ãƒ³ã‚¸ãƒ³ (0.5æ—¥)**
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æˆç´„ç¢ºç‡ç®—å‡º
- [ ] æˆç´„è¦å› åˆ†æã‚·ã‚¹ãƒ†ãƒ 
- [ ] æœ€é©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰
- [ ] å–¶æ¥­ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬

---

## ğŸ”§ **è©³ç´°å®Ÿè£…ã‚¬ã‚¤ãƒ‰**

### **4.1 LINE/Discordè‡ªç„¶è¨€èªå‡¦ç†å¼·åŒ–**

#### **4.1.1 é«˜åº¦è‡ªç„¶è¨€èªå‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…**
```typescript
// src/services/EnhancedNLPProcessor.ts
import { AI_SERVICE } from './ai-service';

export interface ConversationContext {
  userId: string;
  platform: 'LINE' | 'DISCORD';
  conversationHistory: Array<{
    timestamp: Date;
    message: string;
    intent: string;
    entities: Record<string, any>;
    action: string;
    result: string;
  }>;
  userProfile: {
    role: string;
    preferences: Record<string, any>;
    currentProjects: string[];
    recentActivity: string[];
  };
  currentSession: {
    activeTask: string | null;
    multiStepProcess: string | null;
    awaitingInput: string | null;
  };
}

export interface NLPResult {
  intent: {
    primary: string;
    confidence: number;
    secondary?: string;
  };
  entities: {
    dates?: Date[];
    people?: string[];
    projects?: string[];
    tasks?: string[];
    amounts?: number[];
    locations?: string[];
  };
  sentiment: {
    polarity: number; // -1 to 1
    confidence: number;
  };
  actionPlan: {
    immediateAction: string;
    followUpActions: string[];
    confirmationRequired: boolean;
    additionalInputNeeded: string[];
  };
  response: {
    text: string;
    quickReplies?: string[];
    attachments?: any[];
  };
}

export class EnhancedNLPProcessor {
  private conversationContexts: Map<string, ConversationContext> = new Map();

  constructor(
    private aiService: typeof AI_SERVICE,
    private taskService: any,
    private appointmentService: any,
    private projectService: any
  ) {}

  /**
   * åŒ…æ‹¬çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†
   */
  async processMessage(
    message: string,
    userId: string,
    platform: 'LINE' | 'DISCORD',
    attachments?: any[]
  ): Promise<NLPResult> {
    
    const context = await this.getOrCreateContext(userId, platform);
    const userProfile = await this.getUserProfile(userId);
    
    // ç”»åƒãƒ»éŸ³å£°å‡¦ç†ï¼ˆæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆï¼‰
    let enhancedMessage = message;
    if (attachments && attachments.length > 0) {
      const mediaAnalysis = await this.processAttachments(attachments);
      enhancedMessage += `\n[æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ: ${mediaAnalysis}]`;
    }
    
    // AI ã«ã‚ˆã‚‹é«˜åº¦è‡ªç„¶è¨€èªç†è§£
    const nlpAnalysis = await this.aiService.evaluateWithGemini(`
    é«˜åº¦è‡ªç„¶è¨€èªå‡¦ç†ãƒ»æ„å›³ç†è§£:
    
    ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±:
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}
    - å½¹å‰²: ${userProfile.role}
    - ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ${platform}
    
    ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:
    - é€²è¡Œä¸­ã‚¿ã‚¹ã‚¯: ${context.currentSession.activeTask || 'ãªã—'}
    - ãƒãƒ«ãƒã‚¹ãƒ†ãƒƒãƒ—å‡¦ç†: ${context.currentSession.multiStepProcess || 'ãªã—'}
    - å¾…æ©Ÿä¸­å…¥åŠ›: ${context.currentSession.awaitingInput || 'ãªã—'}
    
    æœ€è¿‘ã®ä¼šè©±å±¥æ­´ (ç›´è¿‘5ä»¶):
    ${context.conversationHistory.slice(-5).map(conv => 
      `- ${conv.timestamp.toISOString()}: ${conv.message} â†’ ${conv.intent} (${conv.action})`
    ).join('\n')}
    
    ç¾åœ¨é€²è¡Œä¸­ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:
    ${userProfile.currentProjects.map(p => `- ${p}`).join('\n')}
    
    å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "${enhancedMessage}"
    
    ä»¥ä¸‹ã®è¦³ç‚¹ã§åŒ…æ‹¬çš„ãªè‡ªç„¶è¨€èªç†è§£ã‚’å®Ÿè¡Œ:
    
    1. æ„å›³ç†è§£ãƒ»åˆ†é¡:
       - ä¸»è¦æ„å›³: ã‚¿ã‚¹ã‚¯æ“ä½œ/ã‚¢ãƒã‚¤ãƒ³ãƒˆç®¡ç†/æƒ…å ±å–å¾—/å ±å‘Šãƒ»æ›´æ–°/æ‰¿èªä¾é ¼/ãã®ä»–
       - ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ (0-1)
       - å‰¯æ¬¡çš„æ„å›³ï¼ˆè¤‡åˆçš„ãªè¦æ±‚ã®å ´åˆï¼‰
    
    2. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡º:
       - æ—¥æ™‚è¡¨ç¾: ã€Œæ˜æ—¥ã®åˆå¾Œã€ã€Œæ¥é€±ã®é‡‘æ›œæ—¥ã€ãªã©è‡ªç„¶ãªè¡¨ç¾ã‚’æ­£ç¢ºãªæ—¥æ™‚ã«å¤‰æ›
       - äººç‰©ãƒ»çµ„ç¹”å: ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒ»åå‰ãƒ»å½¹è·ã®è­˜åˆ¥
       - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¿ã‚¹ã‚¯å: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®ç…§åˆãƒ»é¡ä¼¼æ€§åˆ¤å®š
       - æ•°å€¤ãƒ»é‡‘é¡: æ•°å­—è¡¨ç¾ã®æ­£è¦åŒ–
       - å ´æ‰€ãƒ»ä½ç½®æƒ…å ±: ä½æ‰€ãƒ»æ–½è¨­åãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¼šè­°å®¤ç­‰
    
    3. æ„Ÿæƒ…ãƒ»ãƒˆãƒ¼ãƒ³åˆ†æ:
       - æ„Ÿæƒ…æ¥µæ€§: ãƒã‚¸ãƒ†ã‚£ãƒ–/ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«/ãƒã‚¬ãƒ†ã‚£ãƒ–
       - ç·Šæ€¥åº¦: æ€¥ã/é€šå¸¸/ä½™è£•ã‚ã‚Š
       - é‡è¦åº¦: é«˜/ä¸­/ä½
    
    4. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ±ºå®š:
       - å³åº§å®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
       - è¿½åŠ æƒ…å ±ãŒå¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
       - ç¢ºèªãŒå¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
       - è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ãŒå¿…è¦ãªãƒ—ãƒ­ã‚»ã‚¹
    
    5. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¶™ç¶šæ€§:
       - å‰å›ã®ä¼šè©±ã¨ã®é–¢é€£æ€§
       - æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã¨ã®é–¢ä¿‚
       - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶šã®å¿…è¦æ€§
    
    6. å¿œç­”ç”Ÿæˆ:
       - è‡ªç„¶ã§è¦ªã—ã¿ã‚„ã™ã„å¿œç­”æ–‡
       - å¿…è¦ã«å¿œã˜ãŸã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤é¸æŠè‚¢
       - è¿½åŠ æƒ…å ±ãƒ»ç¢ºèªäº‹é …ã®æ˜ç¤º
    
    ç‰¹ã«ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œ:
    
    ã‚¿ã‚¹ã‚¯é–¢é€£:
    - "æ˜æ—¥ã¾ã§ã«Reactã®ä½œæ¥­çµ‚ã‚ã‚‰ã›ã‚‹" â†’ ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»æœŸé™è¨­å®š
    - "ä»Šã‚„ã£ã¦ã‚‹ã‚¿ã‚¹ã‚¯ã®é€²æ—ã©ã†ï¼Ÿ" â†’ é€²æ—ç¢ºèªãƒ»å ±å‘Š
    - "Aæ¡ˆä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’Bã•ã‚“ã«ç§»ã™" â†’ æ‹…å½“è€…å¤‰æ›´
    
    ã‚¢ãƒã‚¤ãƒ³ãƒˆé–¢é€£:
    - "æ¥é€±Cç¤¾ã¨æ‰“ã¡åˆã‚ã›å…¥ã‚Œã¦" â†’ ã‚¢ãƒã‚¤ãƒ³ãƒˆä½œæˆãƒ»èª¿æ•´
    - "é‡‘æ›œæ—¥ã®ä¼šè­°ã®è³‡æ–™æº–å‚™å®Œäº†" â†’ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    - "Dç¤¾ã¨ã®å¥‘ç´„æˆç«‹ã—ãŸã‚ˆ" â†’ å¥‘ç´„å‡¦ç†é–‹å§‹
    
    æƒ…å ±å–å¾—:
    - "ä»Šæœˆã®å£²ä¸Šå®Ÿç¸¾æ•™ãˆã¦" â†’ ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ»é›†è¨ˆ
    - "Eç¤¾ã®éå»æ¡ˆä»¶ã®æƒ…å ±ã¯ï¼Ÿ" â†’ å±¥æ­´æ¤œç´¢ãƒ»è¡¨ç¤º
    - "æ¥é€±ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèª" â†’ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±å–å¾—
    
    å›ç­”å½¢å¼:
    {
      "intent": {
        "primary": "TASK_CREATION",
        "confidence": 0.95,
        "secondary": "DEADLINE_SETTING"
      },
      "entities": {
        "dates": ["2025-07-15T23:59:59Z"],
        "people": ["ç”°ä¸­ã•ã‚“"],
        "projects": ["Reacté–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ"],
        "tasks": ["UIå®Ÿè£…"],
        "amounts": [100000]
      },
      "sentiment": {
        "polarity": 0.2,
        "confidence": 0.8
      },
      "actionPlan": {
        "immediateAction": "CREATE_TASK",
        "followUpActions": ["SEND_NOTIFICATION", "UPDATE_PROJECT_STATUS"],
        "confirmationRequired": true,
        "additionalInputNeeded": ["priority", "estimatedHours"]
      },
      "response": {
        "text": "Reactä½œæ¥­ã®ã‚¿ã‚¹ã‚¯ã‚’æ˜æ—¥æœŸé™ã§ä½œæˆã—ã¾ã™ã­ï¼å„ªå…ˆåº¦ã¨äºˆæƒ³å·¥æ•°ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
        "quickReplies": ["å„ªå…ˆåº¦: é«˜", "å„ªå…ˆåº¦: ä¸­", "å„ªå…ˆåº¦: ä½"],
        "attachments": []
      }
    }
    `);

    const result = this.parseNLPResult(nlpAnalysis);
    
    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    await this.updateContext(userId, message, result);
    
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    await this.executeAction(result, userId, context);
    
    return result;
  }

  /**
   * ãƒãƒ«ãƒã‚¹ãƒ†ãƒƒãƒ—ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†
   */
  async handleMultiStepProcess(
    userId: string,
    processType: string,
    currentStep: number,
    userInput: string
  ): Promise<{
    nextStep: number;
    completed: boolean;
    response: string;
    data: Record<string, any>;
  }> {
    
    const context = this.conversationContexts.get(userId);
    const processDefinition = await this.getProcessDefinition(processType);
    
    const stepAnalysis = await this.aiService.evaluateWithGemini(`
    ãƒãƒ«ãƒã‚¹ãƒ†ãƒƒãƒ—ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†:
    
    ãƒ—ãƒ­ã‚»ã‚¹: ${processType}
    ç¾åœ¨ã‚¹ãƒ†ãƒƒãƒ—: ${currentStep}/${processDefinition.totalSteps}
    ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: "${userInput}"
    
    ãƒ—ãƒ­ã‚»ã‚¹å®šç¾©:
    ${processDefinition.steps.map((step, index) => 
      `${index + 1}. ${step.name}: ${step.description}`
    ).join('\n')}
    
    ç¾åœ¨ã®åé›†ãƒ‡ãƒ¼ã‚¿:
    ${Object.entries(context?.currentSession || {}).map(([key, value]) => 
      `- ${key}: ${value}`
    ).join('\n')}
    
    æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šã¨å¿œç­”ç”Ÿæˆ:
    
    å›ç­”å½¢å¼: JSON
    `);

    return this.parseStepResult(stepAnalysis);
  }

  /**
   * éŸ³å£°ãƒ»ç”»åƒèªè­˜å‡¦ç†
   */
  private async processAttachments(attachments: any[]): Promise<string> {
    const analyses = [];
    
    for (const attachment of attachments) {
      if (attachment.type === 'image') {
        const imageAnalysis = await this.analyzeImage(attachment.url);
        analyses.push(`ç”»åƒ: ${imageAnalysis}`);
      } else if (attachment.type === 'audio') {
        const audioTranscription = await this.transcribeAudio(attachment.url);
        analyses.push(`éŸ³å£°: ${audioTranscription}`);
      } else if (attachment.type === 'document') {
        const documentAnalysis = await this.analyzeDocument(attachment.url);
        analyses.push(`æ–‡æ›¸: ${documentAnalysis}`);
      }
    }
    
    return analyses.join(', ');
  }

  /**
   * ç”»åƒè§£æï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€å›³è¡¨ã€å†™çœŸç­‰ï¼‰
   */
  private async analyzeImage(imageUrl: string): Promise<string> {
    const analysis = await this.aiService.analyzeImage(imageUrl, `
    ã“ã®ç”»åƒã‚’åˆ†æã—ã¦ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡º:
    
    1. ç”»åƒã‚¿ã‚¤ãƒ—: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ/å›³è¡¨/å†™çœŸ/ãã®ä»–
    2. å«ã¾ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆ: OCRã«ã‚ˆã‚‹ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
    3. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¦ç´ : ã‚°ãƒ©ãƒ•/è¡¨/UIè¦ç´ /ãã®ä»–
    4. ãƒ“ã‚¸ãƒã‚¹é–¢é€£æƒ…å ±: ãƒ‡ãƒ¼ã‚¿/ãƒ¡ãƒˆãƒªã‚¯ã‚¹/é€²æ—/èª²é¡Œç­‰
    5. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½ãªæƒ…å ±: ä½œæˆã™ã¹ãã‚¿ã‚¹ã‚¯/è¨˜éŒ²ã™ã¹ãæƒ…å ±ç­‰
    
    ç°¡æ½”ã«è¦ç´„ã—ã¦è¿”ç­”ã€‚
    `);
    
    return analysis || 'ç”»åƒè§£æã«å¤±æ•—ã—ã¾ã—ãŸ';
  }

  /**
   * éŸ³å£°æ–‡å­—èµ·ã“ã—ãƒ»è§£æ
   */
  private async transcribeAudio(audioUrl: string): Promise<string> {
    // éŸ³å£°æ–‡å­—èµ·ã“ã—ã‚µãƒ¼ãƒ“ã‚¹é€£æº
    const transcription = await this.audioTranscriptionService.transcribe(audioUrl);
    
    const analysis = await this.aiService.evaluateWithGemini(`
    éŸ³å£°æ–‡å­—èµ·ã“ã—çµæœã®åˆ†æ:
    
    æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆ: "${transcription}"
    
    ä»¥ä¸‹ã®è¦³ç‚¹ã§åˆ†æ:
    1. ä¸»è¦ãªå†…å®¹ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    2. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é …ç›®ãƒ»TODO
    3. é‡è¦ãªæ•°å€¤ãƒ»æ—¥ä»˜ãƒ»åå‰
    4. æ„Ÿæƒ…ãƒ»ãƒˆãƒ¼ãƒ³ãƒ»ç·Šæ€¥åº¦
    
    ç°¡æ½”ã«è¦ç´„ã—ã¦è¿”ç­”ã€‚
    `);
    
    return analysis || transcription || 'éŸ³å£°è§£æã«å¤±æ•—ã—ã¾ã—ãŸ';
  }

  /**
   * ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³
   */
  private async executeAction(
    nlpResult: NLPResult,
    userId: string,
    context: ConversationContext
  ): Promise<void> {
    
    const action = nlpResult.actionPlan.immediateAction;
    
    try {
      switch (action) {
        case 'CREATE_TASK':
          await this.createTaskFromNLP(nlpResult, userId);
          break;
          
        case 'UPDATE_TASK':
          await this.updateTaskFromNLP(nlpResult, userId);
          break;
          
        case 'CREATE_APPOINTMENT':
          await this.createAppointmentFromNLP(nlpResult, userId);
          break;
          
        case 'UPDATE_APPOINTMENT':
          await this.updateAppointmentFromNLP(nlpResult, userId);
          break;
          
        case 'SEARCH_INFORMATION':
          await this.searchInformationFromNLP(nlpResult, userId);
          break;
          
        case 'GENERATE_REPORT':
          await this.generateReportFromNLP(nlpResult, userId);
          break;
          
        case 'APPROVE_REQUEST':
          await this.processApprovalFromNLP(nlpResult, userId);
          break;
          
        default:
          console.log(`Unknown action: ${action}`);
      }
      
      // ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      for (const followUpAction of nlpResult.actionPlan.followUpActions) {
        await this.executeFollowUpAction(followUpAction, nlpResult, userId);
      }
      
    } catch (error) {
      console.error('Action execution error:', error);
      // ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥
      await this.notifyActionError(userId, action, error);
    }
  }

  /**
   * ã‚¿ã‚¹ã‚¯ä½œæˆï¼ˆè‡ªç„¶è¨€èªã‹ã‚‰ï¼‰
   */
  private async createTaskFromNLP(nlpResult: NLPResult, userId: string): Promise<void> {
    const entities = nlpResult.entities;
    
    const taskData = {
      title: this.extractTaskTitle(nlpResult),
      description: this.extractTaskDescription(nlpResult),
      dueDate: entities.dates?.[0] || null,
      assignedTo: entities.people?.[0] ? await this.resolvePersonToUserId(entities.people[0]) : userId,
      projectId: entities.projects?.[0] ? await this.resolveProjectId(entities.projects[0]) : null,
      priority: this.extractPriority(nlpResult),
      estimatedHours: this.extractEstimatedHours(nlpResult),
      createdBy: userId
    };
    
    const task = await this.taskService.create(taskData);
    
    // æˆåŠŸé€šçŸ¥
    await this.sendPlatformMessage(userId, `ã‚¿ã‚¹ã‚¯ã€Œ${task.title}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼`);
  }

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
  private async getOrCreateContext(userId: string, platform: 'LINE' | 'DISCORD'): Promise<ConversationContext> {
    if (!this.conversationContexts.has(userId)) {
      const userProfile = await this.getUserProfile(userId);
      const context: ConversationContext = {
        userId,
        platform,
        conversationHistory: [],
        userProfile,
        currentSession: {
          activeTask: null,
          multiStepProcess: null,
          awaitingInput: null
        }
      };
      this.conversationContexts.set(userId, context);
    }
    
    return this.conversationContexts.get(userId)!;
  }

  private parseNLPResult(aiResponse: string): NLPResult {
    try {
      return JSON.parse(aiResponse);
    } catch (error) {
      console.error('NLP result parsing error:', error);
      return {
        intent: { primary: 'UNKNOWN', confidence: 0.1 },
        entities: {},
        sentiment: { polarity: 0, confidence: 0.5 },
        actionPlan: {
          immediateAction: 'MANUAL_HANDLING',
          followUpActions: [],
          confirmationRequired: true,
          additionalInputNeeded: []
        },
        response: {
          text: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†å°‘ã—å…·ä½“çš„ã«æ•™ãˆã¦ãã ã•ã„ã€‚',
          quickReplies: ['ã‚¿ã‚¹ã‚¯ä½œæˆ', 'ã‚¢ãƒã‚¤ãƒ³ãƒˆç¢ºèª', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ³']
        }
      };
    }
  }
}
```

### **4.2 å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ **

#### **4.2.1 åŒ…æ‹¬çš„å–¶æ¥­è‡ªå‹•åŒ–ã‚¨ãƒ³ã‚¸ãƒ³**
```typescript
// src/services/SalesProcessAutomator.ts
import { AI_SERVICE } from './ai-service';

export interface SalesProcessState {
  appointmentId: string;
  currentPhase: 'LEAD' | 'QUALIFIED' | 'PROPOSAL' | 'NEGOTIATION' | 'CLOSING' | 'CONTRACT';
  processingStatus: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED';
  relationshipStatus: 'FIRST_CONTACT' | 'RAPPORT_BUILDING' | 'TRUST_ESTABLISHED' | 'PARTNER';
  automatedActions: Array<{
    action: string;
    status: 'PENDING' | 'COMPLETED' | 'FAILED';
    scheduledAt: Date;
    completedAt?: Date;
    result?: string;
  }>;
  nextRecommendedAction: {
    action: string;
    timing: Date;
    reasoning: string;
    probability: number;
  };
}

export interface ContractProcessingResult {
  contractId: string;
  backOfficeTasksCreated: Array<{
    taskId: string;
    title: string;
    assignee: string;
    dueDate: Date;
  }>;
  knowledgeItemsGenerated: Array<{
    knowledgeId: string;
    title: string;
    category: string;
  }>;
  followUpAppointments: Array<{
    appointmentId: string;
    purpose: string;
    scheduledDate: Date;
  }>;
  automatedNotifications: string[];
}

export class SalesProcessAutomator {
  constructor(
    private aiService: typeof AI_SERVICE,
    private appointmentService: any,
    private taskService: any,
    private knowledgeService: any,
    private connectionService: any
  ) {}

  /**
   * å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ç›£è¦–ãƒ»è‡ªå‹•é€²è¡Œ
   */
  async monitorAndAdvanceSalesProcess(appointmentId: string): Promise<SalesProcessState> {
    
    const appointment = await this.appointmentService.getAppointment(appointmentId);
    const connectionAnalysis = await this.getConnectionAnalysis(appointment.connectionId);
    const interactionHistory = await this.getInteractionHistory(appointment.connectionId);
    const currentState = await this.getCurrentProcessState(appointmentId);
    
    const processAnalysis = await this.aiService.evaluateWithGemini(`
    å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹åˆ†æãƒ»è‡ªå‹•é€²è¡Œåˆ¤å®š:
    
    ã‚¢ãƒã‚¤ãƒ³ãƒˆæƒ…å ±:
    - ID: ${appointmentId}
    - ä¼æ¥­: ${appointment.companyName}
    - ç›®çš„: ${appointment.purpose}
    - ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚º: ${currentState.currentPhase}
    - å‡¦ç†çŠ¶æ³: ${currentState.processingStatus}
    - é–¢ä¿‚æ€§: ${currentState.relationshipStatus}
    
    ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³åˆ†æ:
    - é–¢ä¿‚æ€§ã‚¹ã‚³ã‚¢: ${connectionAnalysis.relationshipScore}/100
    - æˆåŠŸç¢ºç‡: ${connectionAnalysis.successProbability}
    - äºˆæ¸¬LTV: ${connectionAnalysis.predictedLTV}å††
    
    æœ€è¿‘ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³:
    ${interactionHistory.slice(-5).map(interaction => 
      `- ${interaction.date}: ${interaction.type} - ${interaction.summary}`
    ).join('\n')}
    
    ç¾åœ¨ã®è‡ªå‹•åŒ–ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ³:
    ${currentState.automatedActions.map(action => 
      `- ${action.action}: ${action.status}`
    ).join('\n')}
    
    ä»¥ä¸‹ã®è¦³ç‚¹ã§å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹åˆ†æãƒ»é€²è¡Œåˆ¤å®š:
    
    1. ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œåˆ¤å®š:
       - ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚ºã®å®Œäº†æ¡ä»¶é”æˆåº¦
       - æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®ç§»è¡Œå¯èƒ½æ€§
       - å¿…è¦ãªè¿½åŠ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»æƒ…å ±
    
    2. é–¢ä¿‚æ€§ç™ºå±•è©•ä¾¡:
       - ä¿¡é ¼é–¢ä¿‚ã®æ§‹ç¯‰åº¦
       - æ„æ€æ±ºå®šãƒ—ãƒ­ã‚»ã‚¹ã®ç†è§£åº¦
       - ã‚­ãƒ¼ãƒ‘ãƒ¼ã‚½ãƒ³ã¨ã®æ¥è§¦çŠ¶æ³
    
    3. æˆç´„å¯èƒ½æ€§åˆ†æ:
       - ç¾åœ¨ã®æˆç´„ç¢ºç‡
       - ä¸»è¦ãªæˆç´„é˜»å®³è¦å› 
       - æˆç´„ç¢ºç‡å‘ä¸Šã®ãŸã‚ã®æ–½ç­–
    
    4. è‡ªå‹•åŒ–ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®š:
       - å®Ÿè¡Œã™ã¹ãè‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
       - ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ»é †åºã®æœ€é©åŒ–
       - æ‰‹å‹•ä»‹å…¥ãŒå¿…è¦ãªé ˜åŸŸ
    
    5. æ¬¡ã‚¹ãƒ†ãƒƒãƒ—æ¨å¥¨:
       - æœ€ã‚‚åŠ¹æœçš„ãªæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
       - å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æœ€é©åŒ–
       - æœŸå¾…ã•ã‚Œã‚‹çµæœãƒ»å½±éŸ¿
    
    å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹åˆ¥ã®è‡ªå‹•åŒ–åˆ¤å®š:
    
    LEAD â†’ QUALIFIED:
    - åŸºæœ¬æƒ…å ±åé›†å®Œäº†åº¦
    - äºˆç®—ãƒ»æ¨©é™ãƒ»ãƒ‹ãƒ¼ã‚ºãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ç¢ºèª
    - åˆå›ææ¡ˆè³‡æ–™ã®æº–å‚™çŠ¶æ³
    
    QUALIFIED â†’ PROPOSAL:
    - è©³ç´°è¦ä»¶ã®æŠŠæ¡åº¦
    - ææ¡ˆæ›¸ãƒ»è¦‹ç©ã‚‚ã‚Šã®æº–å‚™å®Œäº†
    - ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ—¥ç¨‹ã®èª¿æ•´
    
    PROPOSAL â†’ NEGOTIATION:
    - ææ¡ˆã«å¯¾ã™ã‚‹åå¿œãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    - ä¾¡æ ¼ãƒ»æ¡ä»¶äº¤æ¸‰ã®é–‹å§‹
    - ç«¶åˆä»–ç¤¾ã¨ã®æ¯”è¼ƒçŠ¶æ³
    
    NEGOTIATION â†’ CLOSING:
    - ä¸»è¦æ¡ä»¶ã®åˆæ„çŠ¶æ³
    - æ„æ€æ±ºå®šè€…ã®æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹
    - å¥‘ç´„ç· çµã®æº–å‚™çŠ¶æ³
    
    CLOSING â†’ CONTRACT:
    - å¥‘ç´„æ›¸ä½œæˆãƒ»ç¢ºèªå®Œäº†
    - ç½²åãƒ»æºå°ã®æ‰‹ç¶šãçŠ¶æ³
    - ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹é€£æºã®å¿…è¦æ€§
    
    å›ç­”å½¢å¼:
    {
      "appointmentId": "${appointmentId}",
      "currentPhase": "PROPOSAL",
      "processingStatus": "IN_PROGRESS",
      "relationshipStatus": "TRUST_ESTABLISHED",
      "automatedActions": [
        {
          "action": "ææ¡ˆæ›¸ä½œæˆãƒ»é€ä»˜",
          "status": "PENDING",
          "scheduledAt": "2025-07-15T10:00:00Z",
          "result": null
        }
      ],
      "nextRecommendedAction": {
        "action": "ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—é›»è©±",
        "timing": "2025-07-16T14:00:00Z",
        "reasoning": "ææ¡ˆæ›¸é€ä»˜å¾Œ24æ™‚é–“ä»¥å†…ã®åå¿œç¢ºèª",
        "probability": 0.8
      }
    }
    `);

    const newState = this.parseProcessState(processAnalysis);
    
    // è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    await this.executeAutomatedActions(newState);
    
    // çŠ¶æ…‹æ›´æ–°ãƒ»ä¿å­˜
    await this.saveProcessState(appointmentId, newState);
    
    return newState;
  }

  /**
   * å¥‘ç´„å‡¦ç†å®Œå…¨è‡ªå‹•åŒ–
   */
  async processContractCompletion(
    appointmentId: string,
    contractDetails: {
      contractValue: number;
      contractType: string;
      duration: number;
      startDate: Date;
      specialTerms?: string[];
    }
  ): Promise<ContractProcessingResult> {
    
    const appointment = await this.appointmentService.getAppointment(appointmentId);
    const connection = await this.connectionService.getConnection(appointment.connectionId);
    
    // AI ã«ã‚ˆã‚‹åŒ…æ‹¬çš„å¥‘ç´„å‡¦ç†è¨ˆç”»
    const processingPlan = await this.aiService.evaluateWithGemini(`
    å¥‘ç´„å‡¦ç†å®Œå…¨è‡ªå‹•åŒ–è¨ˆç”»:
    
    å¥‘ç´„åŸºæœ¬æƒ…å ±:
    - å¥‘ç´„é‡‘é¡: ${contractDetails.contractValue}å††
    - å¥‘ç´„ã‚¿ã‚¤ãƒ—: ${contractDetails.contractType}
    - æœŸé–“: ${contractDetails.duration}ãƒ¶æœˆ
    - é–‹å§‹æ—¥: ${contractDetails.startDate}
    - ç‰¹è¨˜äº‹é …: ${contractDetails.specialTerms?.join(', ') || 'ãªã—'}
    
    é¡§å®¢æƒ…å ±:
    - ä¼æ¥­å: ${connection.companyName}
    - æ¥­ç•Œ: ${connection.industry}
    - è¦æ¨¡: ${connection.employeeCount}å
    - éå»å–å¼•: ${connection.projectHistory?.length || 0}ä»¶
    
    ä»¥ä¸‹ã®è¦ç´ ã‚’åŒ…æ‹¬çš„ã«è‡ªå‹•åŒ–:
    
    1. ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹ã‚¿ã‚¹ã‚¯è‡ªå‹•ç”Ÿæˆ:
       - å¥‘ç´„æ›¸ä½œæˆãƒ»ç¢ºèªãƒ»ç· çµ
       - è«‹æ±‚æ›¸ç™ºè¡Œãƒ»å…¥é‡‘ç¢ºèª
       - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç«‹ã¡ä¸Šã’ãƒ»ãƒãƒ¼ãƒ ç·¨æˆ
       - ã‚­ãƒƒã‚¯ã‚ªãƒ•ä¼šè­°ãƒ»åˆå›æ‰“ã¡åˆã‚ã›
       - é€²æ—ç®¡ç†ãƒ»å ±å‘Šä½“åˆ¶æ§‹ç¯‰
    
    2. ãƒŠãƒ¬ãƒƒã‚¸è‡ªå‹•è“„ç©:
       - å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹ãƒ»æˆåŠŸè¦å› ã®è¨˜éŒ²
       - é¡§å®¢ç‰¹æ€§ãƒ»ãƒ‹ãƒ¼ã‚ºã®åˆ†æ
       - ææ¡ˆå†…å®¹ãƒ»å·®åˆ¥åŒ–ãƒã‚¤ãƒ³ãƒˆ
       - ç«¶åˆæ¯”è¼ƒãƒ»å‹å› åˆ†æ
    
    3. ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è‡ªå‹•åŒ–:
       - å¥‘ç´„å¾Œã®é–¢ä¿‚ç¶­æŒæ–½ç­–
       - è¿½åŠ æ¡ˆä»¶ã®æ©Ÿä¼šå‰µå‡º
       - é¡§å®¢æº€è¶³åº¦å‘ä¸Šæ–½ç­–
       - é•·æœŸçš„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ§‹ç¯‰
    
    4. ãƒãƒ¼ãƒ ãƒ»ãƒªã‚½ãƒ¼ã‚¹èª¿æ•´:
       - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ãƒ ç·¨æˆ
       - å¿…è¦ãƒªã‚½ãƒ¼ã‚¹ã®ç¢ºä¿ãƒ»èª¿æ•´
       - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¨­å®š
       - è²¬ä»»è€…ãƒ»çª“å£ã®æ˜ç¢ºåŒ–
    
    å›ç­”å½¢å¼:
    {
      "backOfficeTasks": [
        {
          "title": "å¥‘ç´„æ›¸ä½œæˆãƒ»ãƒªãƒ¼ã‚¬ãƒ«ãƒã‚§ãƒƒã‚¯",
          "assignee": "legal_team",
          "dueDate": "2025-07-20T17:00:00Z",
          "priority": "A",
          "description": "å¥‘ç´„æ¡ä»¶ã«åŸºã¥ãå¥‘ç´„æ›¸ä½œæˆã¨æ³•å‹™ç¢ºèª"
        }
      ],
      "knowledgeItems": [
        {
          "title": "å–¶æ¥­æˆåŠŸäº‹ä¾‹: ${connection.companyName}",
          "category": "SALES_SUCCESS",
          "content": "è©³ç´°ãªå–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹ãƒ»æˆåŠŸè¦å› åˆ†æ..."
        }
      ],
      "followUpAppointments": [
        {
          "purpose": "ã‚­ãƒƒã‚¯ã‚ªãƒ•ä¼šè­°",
          "scheduledDate": "2025-07-25T10:00:00Z",
          "duration": 120,
          "participants": ["customer_pm", "our_pm"]
        }
      ],
      "notifications": [
        "å–¶æ¥­ãƒãƒ¼ãƒ ã¸ã®æˆç´„å ±å‘Š",
        "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ãƒ ã¸ã®é–‹å§‹é€šçŸ¥",
        "çµŒå–¶é™£ã¸ã®å£²ä¸Šå ±å‘Š"
      ]
    }
    `);

    const plan = this.parseProcessingPlan(processingPlan);
    
    // 1. ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹ã‚¿ã‚¹ã‚¯ä½œæˆ
    const createdTasks = await this.createBackOfficeTasks(plan.backOfficeTasks, appointmentId);
    
    // 2. ãƒŠãƒ¬ãƒƒã‚¸è‡ªå‹•ç”Ÿæˆãƒ»ä¿å­˜
    const generatedKnowledge = await this.generateContractKnowledge(plan.knowledgeItems, appointment, contractDetails);
    
    // 3. ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã‚¢ãƒã‚¤ãƒ³ãƒˆä½œæˆ
    const followUpAppointments = await this.createFollowUpAppointments(plan.followUpAppointments, appointment.connectionId);
    
    // 4. è‡ªå‹•é€šçŸ¥é€ä¿¡
    await this.sendAutomatedNotifications(plan.notifications, appointmentId, contractDetails);
    
    // 5. å¥‘ç´„æƒ…å ±æ›´æ–°
    await this.updateContractInformation(appointmentId, contractDetails);
    
    return {
      contractId: `contract_${appointmentId}_${Date.now()}`,
      backOfficeTasksCreated: createdTasks,
      knowledgeItemsGenerated: generatedKnowledge,
      followUpAppointments: followUpAppointments,
      automatedNotifications: plan.notifications
    };
  }

  /**
   * å–¶æ¥­ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹äºˆæ¸¬ãƒ»æœ€é©åŒ–
   */
  async optimizeSalesPerformance(
    salesPersonId: string,
    timeframe: 'WEEKLY' | 'MONTHLY' | 'QUARTERLY'
  ): Promise<{
    currentPerformance: {
      conversionRate: number;
      averageDealSize: number;
      salesCycleLength: number;
      pipelineHealth: number;
    };
    predictedPerformance: {
      expectedRevenue: number;
      probabilityRange: { min: number; max: number };
      keyRiskFactors: string[];
    };
    optimizationRecommendations: Array<{
      area: string;
      currentValue: number;
      targetValue: number;
      actions: string[];
      expectedImpact: number;
    }>;
  }> {
    
    const salesData = await this.getSalesPersonData(salesPersonId, timeframe);
    const pipelineAnalysis = await this.analyzePipeline(salesPersonId);
    const marketContext = await this.getMarketContext();
    
    const optimization = await this.aiService.evaluateWithGemini(`
    å–¶æ¥­ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–åˆ†æ:
    
    å–¶æ¥­æ‹…å½“è€…: ${salesPersonId}
    åˆ†ææœŸé–“: ${timeframe}
    
    ç¾åœ¨ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹:
    ${Object.entries(salesData.performance).map(([key, value]) => 
      `- ${key}: ${value}`
    ).join('\n')}
    
    ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çŠ¶æ³:
    ${pipelineAnalysis.stages.map(stage => 
      `- ${stage.name}: ${stage.deals}ä»¶ (${stage.totalValue}å††)`
    ).join('\n')}
    
    å¸‚å ´ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:
    - æ¥­ç•Œå¹³å‡æˆç´„ç‡: ${marketContext.industryConversionRate}%
    - å¹³å‡å–¶æ¥­ã‚µã‚¤ã‚¯ãƒ«: ${marketContext.averageSalesCycle}æ—¥
    - å¸‚å ´æˆé•·ç‡: ${marketContext.marketGrowthRate}%
    
    ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–åˆ†æãƒ»æ¨å¥¨äº‹é …:
    
    å›ç­”å½¢å¼: JSON
    `);

    return this.parseOptimizationAnalysis(optimization);
  }

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
  private async executeAutomatedActions(state: SalesProcessState): Promise<void> {
    for (const action of state.automatedActions) {
      if (action.status === 'PENDING' && new Date() >= action.scheduledAt) {
        try {
          await this.executeSpecificAction(action.action, state.appointmentId);
          action.status = 'COMPLETED';
          action.completedAt = new Date();
        } catch (error) {
          action.status = 'FAILED';
          action.result = error.message;
        }
      }
    }
  }

  private async createBackOfficeTasks(
    taskPlans: any[],
    appointmentId: string
  ): Promise<Array<{
    taskId: string;
    title: string;
    assignee: string;
    dueDate: Date;
  }>> {
    
    const createdTasks = [];
    
    for (const plan of taskPlans) {
      const task = await this.taskService.create({
        title: plan.title,
        description: plan.description,
        assignedTo: plan.assignee,
        dueDate: plan.dueDate,
        priority: plan.priority,
        relatedAppointmentId: appointmentId,
        isBackOfficeTask: true,
        tags: ['contract_processing', 'automated']
      });
      
      createdTasks.push({
        taskId: task.id,
        title: task.title,
        assignee: task.assignedTo,
        dueDate: task.dueDate
      });
    }
    
    return createdTasks;
  }

  private async generateContractKnowledge(
    knowledgePlans: any[],
    appointment: any,
    contractDetails: any
  ): Promise<Array<{
    knowledgeId: string;
    title: string;
    category: string;
  }>> {
    
    const generatedKnowledge = [];
    
    for (const plan of knowledgePlans) {
      const knowledge = await this.knowledgeService.create({
        title: plan.title,
        category: plan.category,
        content: plan.content,
        tags: ['sales_success', 'contract', appointment.companyName],
        autoGenerated: true,
        sourceType: 'CONTRACT_COMPLETION',
        sourceDocumentId: appointment.id,
        relatedAppointmentId: appointment.id,
        contractValue: contractDetails.contractValue
      });
      
      generatedKnowledge.push({
        knowledgeId: knowledge.id,
        title: knowledge.title,
        category: knowledge.category
      });
    }
    
    return generatedKnowledge;
  }

  private parseProcessState(aiResponse: string): SalesProcessState {
    try {
      return JSON.parse(aiResponse);
    } catch (error) {
      console.error('Process state parsing error:', error);
      return this.getDefaultProcessState();
    }
  }

  private getDefaultProcessState(): SalesProcessState {
    return {
      appointmentId: '',
      currentPhase: 'LEAD',
      processingStatus: 'PENDING',
      relationshipStatus: 'FIRST_CONTACT',
      automatedActions: [],
      nextRecommendedAction: {
        action: 'æ‰‹å‹•ã§å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„',
        timing: new Date(),
        reasoning: 'AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ',
        probability: 0.5
      }
    };
  }
}
```

---

## ğŸ§ª **Phase 4 ãƒ†ã‚¹ãƒˆè¨ˆç”»**

### **4.1 è‡ªç„¶è¨€èªå‡¦ç†ãƒ†ã‚¹ãƒˆ**
```typescript
// __tests__/EnhancedNLPProcessor.test.ts
describe('Enhanced NLP Processor', () => {
  test('Task creation from natural language', async () => {
    const processor = new EnhancedNLPProcessor();
    const result = await processor.processMessage(
      'æ˜æ—¥ã¾ã§ã«Reactã®ç”»é¢ä½œæˆã‚’ç”°ä¸­ã•ã‚“ã«ãŠé¡˜ã„ã—ã¾ã™',
      'user123',
      'LINE'
    );
    
    expect(result.intent.primary).toBe('TASK_CREATION');
    expect(result.entities.dates).toHaveLength(1);
    expect(result.entities.people).toContain('ç”°ä¸­ã•ã‚“');
    expect(result.actionPlan.immediateAction).toBe('CREATE_TASK');
  });

  test('Appointment scheduling from natural language', async () => {
    const processor = new EnhancedNLPProcessor();
    const result = await processor.processMessage(
      'æ¥é€±ã®é‡‘æ›œæ—¥ã«Aç¤¾ã¨æ‰“ã¡åˆã‚ã›ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„',
      'user123',
      'DISCORD'
    );
    
    expect(result.intent.primary).toBe('CREATE_APPOINTMENT');
    expect(result.entities.dates).toHaveLength(1);
    expect(result.actionPlan.immediateAction).toBe('CREATE_APPOINTMENT');
  });
});
```

### **4.2 å–¶æ¥­è‡ªå‹•åŒ–ãƒ†ã‚¹ãƒˆ**
```typescript
// __tests__/SalesProcessAutomator.test.ts
describe('Sales Process Automator', () => {
  test('Contract processing automation', async () => {
    const automator = new SalesProcessAutomator();
    const result = await automator.processContractCompletion(
      'appointment123',
      {
        contractValue: 1000000,
        contractType: 'DEVELOPMENT',
        duration: 6,
        startDate: new Date('2025-08-01')
      }
    );
    
    expect(result.backOfficeTasksCreated.length).toBeGreaterThan(0);
    expect(result.knowledgeItemsGenerated.length).toBeGreaterThan(0);
    expect(result.contractId).toBeTruthy();
  });
});
```

---

## ğŸ“Š **Phase 4 æˆåŠŸæŒ‡æ¨™**

### **4.1 è‡ªç„¶è¨€èªå‡¦ç†ç²¾åº¦**
- [ ] **æ„å›³èªè­˜ç²¾åº¦**: 90%ä»¥ä¸Š
- [ ] **ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡ºç²¾åº¦**: 85%ä»¥ä¸Š
- [ ] **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡ŒæˆåŠŸç‡**: 95%ä»¥ä¸Š

### **4.2 å–¶æ¥­è‡ªå‹•åŒ–åŠ¹ç‡**
- [ ] **å¥‘ç´„å‡¦ç†è‡ªå‹•åŒ–ç‡**: 80%ä»¥ä¸Š
- [ ] **ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹é€£æº**: 100%è‡ªå‹•åŒ–
- [ ] **ãƒŠãƒ¬ãƒƒã‚¸ç”Ÿæˆç‡**: å¥‘ç´„ã®90%ä»¥ä¸Š

### **4.3 ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
- [ ] **NLPå¿œç­”æ™‚é–“**: < 3ç§’
- [ ] **å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹åˆ†æ**: < 5ç§’
- [ ] **å¥‘ç´„å‡¦ç†å®Œäº†**: < 30ç§’

---

## âš ï¸ **Phase 4 æ³¨æ„äº‹é …**

### **4.1 ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**
- é¡§å®¢æƒ…å ±ã®é©åˆ‡ãªæš—å·åŒ–
- éŸ³å£°ãƒ»ç”»åƒãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªå‡¦ç†
- GDPRãƒ»å€‹äººæƒ…å ±ä¿è­·æ³•ã®éµå®ˆ

### **4.2 è‡ªå‹•åŒ–ã®åˆ¶é™**
- é‡è¦ãªæ„æ€æ±ºå®šã¯äººé–“ã«ã‚ˆã‚‹ç¢ºèª
- å¥‘ç´„æ¡ä»¶ã®æœ€çµ‚ç¢ºèªã¯æ‰‹å‹•
- é¡§å®¢ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯è‡ªç„¶ãªè¡¨ç¾

---

**Phase 4 å®Œäº†åŸºæº–**: è‡ªç„¶è¨€èªå‡¦ç†ç²¾åº¦ç›®æ¨™é”æˆã€å–¶æ¥­è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨å‹•ä½œã€çµ±åˆãƒ†ã‚¹ãƒˆåˆæ ¼